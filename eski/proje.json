{
  "project_name": "VR Cinema ULTRA - Multiplayer Video Synchronization System",
  "version": "7.0",
  "description": "WebRTC tabanlƒ± VR sinema platformu - Ger√ßek zamanlƒ± video senkronizasyonu, multi-kullanƒ±cƒ± desteƒüi, VR/2D/Mobil uyumlu",
  
  "core_architecture": {
    "type": "Real-time Multiplayer VR Application",
    "paradigm": "Client-Server with Firebase Realtime Database",
    "rendering": "A-Frame (WebGL/VR)",
    "sync_mechanism": "Server-time based synchronization with drift compensation",
    
    "key_components": [
      "Firebase Realtime Database - State management & synchronization",
      "A-Frame 1.6.0 - VR/3D rendering engine",
      "Custom sync algorithm - Multi-tier drift correction",
      "WebRTC video streaming - Cross-platform support",
      "Owner Presence System - Automatic ownership transfer"
    ]
  },
  
  "file_structure": {
    "index.html": {
      "purpose": "Ana HTML yapƒ±sƒ± ve UI overlay",
      "key_elements": [
        "UI overlay (oda olu≈üturma/listeleme)",
        "A-Frame 3D sahne container",
        "VR kontrol paneli (2D)",
        "Oda bilgi g√∂stergesi",
        "Senkronizasyon status bildirimi"
      ],
      "libraries": [
        "Firebase 9.22.0 (app, database, auth)",
        "A-Frame 1.6.0",
        "A-Frame Environment Component 1.3.7"
      ]
    },
    
    "config.js": {
      "purpose": "T√ºm konfig√ºrasyon sabitleri ve global deƒüi≈ükenler",
      "critical_constants": {
        "SYNC_TIMING": {
          "SYNCDELAY": "5000ms - Ana senkronizasyon d√∂ng√ºs√º",
          "KEYFRAMEINTERVAL": "7000ms - Keyframe g√∂nderim aralƒ±ƒüƒ±",
          "CLOCKSYNCINTERVAL": "60000ms - Sunucu saat senkronizasyonu",
          "SEEKDEBOUNCEDELAY": "2000ms - Seek debounce",
          "DRIFTUPDATEINTERVAL": "5000ms - Drift rapor aralƒ±ƒüƒ±"
        },
        
        "SYNC_BUFFERS": {
          "PAUSE_REWIND_BUFFER": "4s - Pause sƒ±rasƒ±nda geri sarma",
          "PLAY_BUFFER_TIME": "5000ms - Play i√ßin buffer s√ºresi",
          "PRELOADBUFFERSECONDS": "7s - Preload buffer miktarƒ±",
          "POSITION_REPORT_TIMEOUT": "1000ms - Pozisyon rapor bekleme"
        },
        
        "DRIFT_CORRECTION": {
          "TIER1THRESHOLD": "3000ms - Minimal d√ºzeltme e≈üiƒüi",
          "TIER2THRESHOLD": "7000ms - Hƒ±z ayarlama e≈üiƒüi",
          "TIER3THRESHOLD": "15000ms - Seek gereksinimi e≈üiƒüi",
          "TIERCRITICALTHRESHOLD": "20000ms - Kritik desenkronizasyon",
          "TIER2LAGGINGSPEED": "1.1x - Hafif hƒ±zlandƒ±rma",
          "TIER3GROUPSPEED": "0.88x - Grup yava≈ülatma",
          "TIER3LAGGINGSPEED": "1.25x - Agresif yakalama"
        },
        
        "OWNER_PRESENCE": {
          "OWNERPRESENCEUPDATEINTERVAL": "5000ms - Heartbeat aralƒ±ƒüƒ±",
          "OWNERPRESENCECHECKINTERVAL": "10000ms - Kontrol aralƒ±ƒüƒ±",
          "OWNERPRESENCETIMEOUT": "15000ms - Timeout s√ºresi"
        }
      },
      
      "video_services": {
        "youtube": {
          "pattern": "/(youtu\\.be|youtube\\.com\\/watch\\?v=|\\/embed\\/|\\/v\\/|\\/shorts\\/)([a-zA-Z0-9-]{11})/",
          "transform": "Embed URL'e d√∂n√º≈üt√ºrme",
          "example": "https://www.youtube.com/watch?v=xxx ‚Üí https://www.youtube.com/embed/xxx?autoplay=1"
        },
        "googledrive": {
          "pattern": "/drive\\.google\\.com.*?[?&]?(file\\/d\\/|open\\?id=)([a-zA-Z0-9-]+)/",
          "transform": "Cloudflare Worker proxy √ºzerinden direct link",
          "example": "Google Drive ID'den download linki olu≈üturma"
        },
        "direct": {
          "pattern": "/\\.(mp4|webm|ogg|mov|mkv|m3u8|ts)(\\?.*)?$/i",
          "transform": "Direkt kullanƒ±m"
        }
      },
      
      "environments": {
        "none": "Ortamsƒ±z (siyah arka plan)",
        "default": "Klasik A-Frame ortamƒ±",
        "forest": "Orman ortamƒ±",
        "starry": "Yƒ±ldƒ±zlƒ± gece"
      }
    },
    
    "core1.js": {
      "purpose": "Temel sistem fonksiyonlarƒ± - Clock sync, presence, room join",
      
      "clock_synchronization": {
        "algorithm": "RTT (Round Trip Time) based offset calculation",
        "implementation": "3 √∂rneklem ortalamasƒ±",
        "steps": [
          "1. Client timestamp (t0) kaydet",
          "2. Firebase ServerValue.TIMESTAMP yaz",
          "3. Server timestamp oku",
          "4. Client timestamp (t1) kaydet",
          "5. RTT = t1 - t0",
          "6. offset = serverTime - (t0 + RTT/2)",
          "7. 3 √∂rneklem ortalamasƒ± al ‚Üí clockOffset"
        ],
        "refresh_rate": "60 saniyede bir",
        "precision": "¬±50ms tipik, ¬±100ms maksimum"
      },
      
      "owner_presence_system": {
        "purpose": "Oda sahibinin aktif olduƒüunu izleme ve otomatik ownership transfer",
        "mechanism": "Firebase onDisconnect + lastSeen timestamp",
        "heartbeat": "5 saniyede bir activeViewers/[uid]/lastSeen g√ºncelleme",
        "monitoring": "10 saniyede bir owner kontrol√º",
        "timeout": "15 saniye cevap yoksa transfer",
        "transfer_logic": "Firebase transaction ile atomic ownership deƒüi≈üimi"
      },
      
      "preload_waiting": {
        "purpose": "Geride kalan izleyicilerin owner'a yeti≈ümesini bekletme",
        "trigger": "Play komutu √∂ncesi buffer dolmasƒ± i√ßin",
        "polling": "500ms'de bir owner pozisyonu kontrol",
        "max_wait": "30 saniye (PRELOADWAITINGTIMEOUT)",
        "mechanism": [
          "1. videoElement.currentTime = targetTime - PRELOADBUFFERSECONDS",
          "2. videoElement.pause() (buffer dolsun)",
          "3. 500ms polling ile owner pozisyonu izle",
          "4. Owner hedefe ula≈ütƒ± mƒ±? ‚Üí videoElement.play()",
          "5. 30 saniye timeout ‚Üí zorla play"
        ]
      },
      
      "room_join_flow": {
        "steps": [
          "1. Firebase auth (anonim giri≈ü)",
          "2. Room snapshot al (validation)",
          "3. isRoomOwner = (currentUser.uid === room.owner)",
          "4. activeViewers/[uid] yaz (timestamp, isOwner, drift=0)",
          "5. onDisconnect().remove() ayarla",
          "6. initClockSync() √ßalƒ±≈ütƒ±r",
          "7. create3DScene() - Video + environment setup",
          "8. listenVideoState() - Realtime sync ba≈ülat",
          "9. isRoomOwner ? startKeyframeSending() : listenKeyframes()",
          "10. startDriftTracking() - Her kullanƒ±cƒ± i√ßin",
          "11. setupOwnerPresence() - Heartbeat ba≈ülat"
        ]
      },
      
      "interval_tracking": {
        "purpose": "Memory leak √∂nleme",
        "mechanism": "Set-based interval tracking",
        "functions": [
          "trackInterval(id) - Yeni interval kaydet",
          "clearTrackedInterval(id) - Tek interval temizle",
          "clearAllIntervals() - T√ºm intervallarƒ± temizle (room exit)"
        ]
      }
    },
    
    "core2.js": {
      "purpose": "3D sahne, video kontrolleri, drift tracking",
      
      "scene_creation": {
        "video_element_setup": [
          "1. <video> elementi olu≈ütur (crossorigin='anonymous', playsinline)",
          "2. <a-assets> i√ßine ekle",
          "3. <a-video> entity olu≈ütur (#video-screen)",
          "4. src='#video-player' baƒüla",
          "5. Boyut ayarla (small/medium/large/huge)",
          "6. Pozisyon ayarla (screenPosition: x:0, y:2, z:-10)"
        ],
        
        "environment_setup": {
          "a-frame_component": "environment component kullanƒ±mƒ±",
          "preset_values": ["none", "default", "forest", "starry"],
          "implementation": "<a-entity environment='preset: X'>"
        },
        
        "screen_sizes": {
          "small": "8x4.5 (16:9)",
          "medium": "12x6.75 (16:9)",
          "large": "16x9 (16:9)",
          "huge": "20x11.25 (16:9)"
        }
      },
      
      "subtitle_system": {
        "format": "SRT (SubRip Text)",
        "parser": "Regex-based extraction",
        "regex": "(\\d{2}:\\d{2}:\\d{2},\\d{3}) --> (\\d{2}:\\d{2}:\\d{2},\\d{3})\\n([\\s\\S]*?)(?=\\n\\n|\\n*$)",
        "structure": "Array of {start, end, text}",
        "rendering": "<a-text> positioned at (0, -2, -8)",
        "update_frequency": "Video timeupdate event ile"
      },
      
      "drift_tracking_v7": {
        "purpose": "Her kullanƒ±cƒ±nƒ±n senkronizasyon sapmasƒ±nƒ± izleme",
        "interval": "5000ms (optimized from 2000ms)",
        "calculation": "(videoElement.currentTime - expectedTime) * 1000 ms",
        "threshold": "¬±1000ms deƒüi≈üim varsa g√ºncelle",
        "firebase_write": "activeViewers/[uid]/currentDrift",
        "optimization": "Deƒüer deƒüi≈ümediyse Firebase'e yazma (write reduction)"
      },
      
      "video_controls_v7": {
        "playVideo": {
          "flow_owner": [
            "1. cancelPendingOperations() - √ñnceki i≈ülemleri iptal",
            "2. markOldUpdatesAsProcessed() - Eski g√ºncelleri temizle",
            "3. startTimestamp = getServerTime() + PLAY_BUFFER_TIME",
            "4. preloadTime = currentTime - PRELOADBUFFERSECONDS",
            "5. videoElement.currentTime = preloadTime",
            "6. videoElement.pause() (buffer dolsun)",
            "7. Firebase videoState update (isPlaying:true, startTimestamp)",
            "8. urgentUpdates/push({action:'play', startTimestamp, currentTime})",
            "9. startPreloadWaiting(actualStartTime) - Buffer izle",
            "10. Timeout ‚Üí videoElement.play()"
          ],
          "flow_viewer": "requestVideoControl('play') - Owner'a istek g√∂nder"
        },
        
        "pauseVideo_v7_enhanced": {
          "purpose": "T√ºm izleyicilerin pozisyonunu toplayƒ±p minimum'a seek",
          "flow_owner": [
            "1. cancelPendingOperations()",
            "2. markOldUpdatesAsProcessed()",
            "3. urgentUpdates/push({action:'reportPosition'})",
            "4. Kendi pozisyonu yaz: activeViewers/[uid]/pausePosition",
            "5. POSITION_REPORT_TIMEOUT (1000ms) bekle",
            "6. activeViewers snapshot al",
            "7. T√ºm pausePosition deƒüerlerini topla",
            "8. minPosition = Math.min(...positions)",
            "9. seekTarget = max(0, minPosition - PAUSE_REWIND_BUFFER)",
            "10. videoState update (isPlaying:false, currentTime:seekTarget)",
            "11. urgentUpdates/push({action:'pause', currentTime:seekTarget})",
            "12. videoElement.currentTime = seekTarget",
            "13. videoElement.pause()",
            "14. startBufferPreload(seekTarget + PAUSE_REWIND_BUFFER)"
          ],
          "v7_improvements": [
            "Position reporting ile senkron pause",
            "Minimum pozisyona 4 saniye geri sarma",
            "Pause sonrasƒ± buffer preload (oynatma hazƒ±rlƒ±ƒüƒ±)"
          ]
        },
        
        "stopVideo": {
          "actions": [
            "videoState.currentTime = 0",
            "videoState.isPlaying = false",
            "urgentUpdates push (action:'seek', currentTime:0, shouldPlay:false)"
          ]
        },
        
        "seekVideo": {
          "debounce": "SEEKDEBOUNCEDELAY (2000ms)",
          "rewind": "Seek sƒ±rasƒ±nda 2 saniye geri (SEEKREWINDSECONDS)",
          "preload_logic": [
            "wasPlaying ? preloadTime = newTime - 7s",
            "videoElement.pause()",
            "startPreloadWaiting(newTime)",
            "Owner'a yeti≈üince play()"
          ]
        },
        
        "buffer_preload_v7": {
          "purpose": "Pause durumunda video buffer'ƒ±nƒ± √∂nceden doldurma",
          "trigger": "pauseVideo() veya urgent pause sonrasƒ±",
          "target": "currentTime + PAUSE_REWIND_BUFFER",
          "mechanism": [
            "videoElement.pause() (ama src y√ºkl√º)",
            "Her 1 saniyede buffered ranges kontrol",
            "bufferedEnd >= targetTime ? stop preload"
          ],
          "benefit": "Play tu≈üuna basƒ±ldƒ±ƒüƒ±nda anƒ±nda oynatma (buffer hazƒ±r)"
        }
      },
      
      "timeout_management_v6": {
        "purpose": "Race condition √∂nleme - √ßakƒ±≈üan komutlarƒ± iptal etme",
        "global_variables": [
          "currentPlayTimeout",
          "currentPauseTimeout",
          "currentSeekTimeout"
        ],
        "cancelPendingOperations": "T√ºm bekleyen timeout'larƒ± clearTimeout()"
      },
      
      "urgent_update_cleanup": {
        "markOldUpdatesAsProcessed": [
          "orderByChild('processed').equalTo(false) snapshot al",
          "T√ºm kayƒ±tlarƒ± {processed: true} yap",
          "Prevent duplicate processing"
        ]
      }
    },
    
    "core3.js": {
      "purpose": "Sync correction, listeners, requests",
      
      "sync_correction_algorithm": {
        "tier1_minimal": {
          "threshold": "absDiff < 0.5s",
          "action": "Sadece play/pause d√ºzenle, rate=1.0",
          "reasoning": "√áok k√º√ß√ºk fark, kullanƒ±cƒ± fark etmez"
        },
        
        "tier2_speed_adjustment": {
          "threshold": "0.5s ‚â§ absDiff < 2.0s",
          "action": "playbackRate = diff > 0 ? 1.1 : 0.9",
          "reasoning": "Hafif hƒ±z ayarƒ± ile smooth yakalama"
        },
        
        "tier3_seek": {
          "threshold": "absDiff ‚â• 2.0s",
          "action_urgent": "seek to (targetTime - SEEKREWINDSECONDS)",
          "action_normal": "seek to targetTime",
          "reasoning": "B√ºy√ºk fark, seek ka√ßƒ±nƒ±lmaz",
          "note": "Urgent update'lerde 2s geri sarma (buffer i√ßin)"
        }
      },
      
      "videoState_listener": {
        "path": "rooms/[roomId]/videoState",
        "trigger": "on('value')",
        "frequency": "Her Firebase g√ºncellemede (realtime)",
        "processing": [
          "1. state.currentTime + elapsed (eƒüer isPlaying)",
          "2. applySyncCorrection(targetTime, state.isPlaying, false)"
        ]
      },
      
      "keyframe_system_v7": {
        "sender_owner_only": true,
        "interval": "7000ms",
        "structure": {
          "timestamp": "getServerTime()",
          "currentTime": "videoElement.currentTime",
          "isPlaying": "!videoElement.paused",
          "playbackRate": "videoElement.playbackRate",
          "startTimestamp": "isPlaying ? now : null",
          "currentDrift": "calculateDrift() ms",
          "viewerCount": "Object.keys(activeViewers).length"
        },
        "cleanup": "120 saniyeden eski keyframe'leri sil",
        "listener_viewer": {
          "query": "orderByChild('timestamp').limitToLast(1)",
          "age_check": "age > 10000ms ? ignore",
          "processing": "applySyncCorrection()"
        }
      },
      
      "urgentUpdates_listener_v7": {
        "path": "rooms/[roomId]/urgentUpdates",
        "query": "orderByChild('timestamp').startAt(getServerTime()).limitToLast(5)",
        "trigger": "child_added",
        "deduplication": "lastProcessedTimestamp ile eski update'leri atla",
        "age_limit": "10000ms, sonra sil",
        
        "actions": {
          "reportPosition": {
            "purpose": "Pause √∂ncesi pozisyon toplama",
            "action": "activeViewers/[uid]/pausePosition = currentTime"
          },
          
          "play": {
            "delay_check": "startTimestamp - getServerTime()",
            "positive_delay": [
              "preloadTime = currentTime - 7s",
              "seek to preloadTime",
              "pause()",
              "startPreloadWaiting(currentTime)",
              "Owner'a yeti≈üince play()"
            ],
            "negative_delay": "applySyncCorrection() (ge√ß kaldƒ±k, direkt sync)"
          },
          
          "pause": {
            "action": "applySyncCorrection(currentTime, false, true)",
            "v7_addition": "startBufferPreload(currentTime + 4s)"
          },
          
          "seek": {
            "shouldPlay_true": [
              "preloadTime = newTime - 7s",
              "seek to preloadTime",
              "pause()",
              "startPreloadWaiting(newTime)"
            ],
            "shouldPlay_false": "applySyncCorrection(newTime, false)"
          }
        },
        
        "processed_marking": "Her i≈ülem sonrasƒ± {processed: true}",
        "auto_delete": "30 saniye sonra kaydƒ± sil"
      },
      
      "request_system": {
        "purpose": "Viewer'larƒ±n owner'a kontrol isteƒüi g√∂ndermesi",
        "path": "rooms/[roomId]/requests",
        "structure": {
          "userId": "auth.currentUser.uid",
          "action": "play|pause|seek|stop",
          "timestamp": "getServerTime()",
          "processed": false,
          "params": {
            "seconds": "¬±10 (seek i√ßin)",
            "percentage": "0-1 (seekbar i√ßin)"
          }
        },
        
        "owner_processing": {
          "query": "orderByChild('processed').equalTo(false).limitToLast(5)",
          "age_limit": "30000ms",
          "ui": "confirm() dialog - Kullanƒ±cƒ± onayƒ±",
          "execution": "Onaylanƒ±rsa ilgili video fonksiyonunu √ßalƒ±≈ütƒ±r"
        }
      },
      
      "leaveRoom": {
        "cleanup_checklist": [
          "1. cancelPendingOperations() - Timeout'larƒ± iptal",
          "2. viewers counter transaction (decrement)",
          "3. activeViewers/[uid].remove()",
          "4. All listeners off()",
          "5. clearAllIntervals()",
          "6. stopBufferPreload()",
          "7. stopPreloadWaiting()",
          "8. videoElement.pause() + src=''",
          "9. DOM cleanup (screen, environment, panel)",
          "10. Global deƒüi≈ükenleri null",
          "11. showSection('lobby-section')"
        ]
      }
    },
    
    "ui1.js": {
      "purpose": "UI management, room creation, video library",
      
      "video_library": {
        "storage": "Firebase /videoLibrary node",
        "structure": {
          "url": "Video direct link",
          "title": "G√∂r√ºnen ba≈ülƒ±k",
          "addedAt": "Timestamp"
        },
        "default_videos": [
          "https://vr-sinema.online/videos/revolver-turkce-dublaj.mp4",
          "https://vr-sinema.online/videos/chocolat-cikolata-2000-turkce-dublaj.mp4"
        ],
        "auto_save": "Manuel girilen URL'ler otomatik k√ºt√ºphaneye eklenir",
        "duplicate_check": "orderByChild('url').equalTo(url) ile kontrol"
      },
      
      "video_service_detection": {
        "function": "detectVideoService(url)",
        "services": ["youtube", "googledrive", "direct"],
        "transform": "getVideoUrl(inputUrl) ‚Üí playable URL"
      },
      
      "room_creation_flow": {
        "validation": [
          "roomName !== empty",
          "videoUrl !== empty (dropdown ya da manuel)"
        ],
        "auth": "signInAnonymously()",
        "firebase_push": "roomsRef.push(roomData)",
        "roomData_structure": {
          "name": "string",
          "videoUrl": "transformed URL",
          "subtitleUrl": "string | null",
          "environment": "none|default|forest|starry",
          "screenSize": "small|medium|large|huge",
          "owner": "auth.currentUser.uid",
          "isPrivate": "boolean",
          "password": "string | null",
          "controlMode": "owner|everyone",
          "createdAt": "Date.now()",
          "videoState": {
            "isPlaying": false,
            "currentTime": 0,
            "startTimestamp": null,
            "lastUpdate": "Date.now()"
          }
        },
        "post_creation": "joinRoom(newRoomRef.key)"
      },
      
      "room_listing": {
        "query": "roomsRef.once('value')",
        "display_info": [
          "room.name (üîí prefix if private)",
          "viewer count (activeViewers.length)",
          "environment name"
        ],
        "join_flow": "isPrivate ? prompt(password) : direct join"
      },
      
      "throttle_utility": {
        "updateRoomInfoDisplay": "3000ms throttle",
        "purpose": "Firebase read azaltma"
      }
    },
    
    "ui2.js": {
      "purpose": "Room controls, video setup, subtitle",
      
      "updateRoomControls": {
        "logic": "canControl = isRoomOwner || controlMode === 'everyone'",
        "ui_update": "Button disabled/enabled states",
        "owner_badge": "G√∂r√ºn√ºrl√ºk toggle"
      },
      
      "setupVideo": {
        "steps": [
          "1. getVideoUrl() - Transform URL",
          "2. setupVideoTexture() - Create <a-video>",
          "3. Environment component update"
        ]
      },
      
      "setupVideoTexture": {
        "screen_geometries": {
          "360": "sphere primitive, radius:50, side:back, scale:(-1,1,1)",
          "180": "sphere primitive, radius:25, thetaLength:180",
          "flat": "plane primitive, width x height"
        },
        "video_element": {
          "id": "video-src",
          "crossOrigin": "anonymous",
          "preload": "metadata",
          "loop": false,
          "playsInline": true,
          "muted": false
        },
        "event_listeners": [
          "loadedmetadata - Duration log",
          "canplay - screen.visible = true",
          "error - Alert user"
        ]
      },
      
      "subtitle_system": {
        "loadSubtitles": "fetch ‚Üí parseSRT ‚Üí render",
        "parseSRT": "SRT format parser (HH:MM:SS,mmm ‚Üí seconds)",
        "rendering": "<a-text> at (0, -3, -10)",
        "update_interval": "100ms subtitle check loop"
      },
      
      "showSection": {
        "lobby": [
          "ui-overlay show",
          "vr-controls hide",
          "room-info hide",
          "loadRoomList()"
        ],
        "room": [
          "ui-overlay hide",
          "vr-controls show",
          "room-info show"
        ]
      },
      
      "loadVideo_promise": {
        "purpose": "Async video loading with error handling",
        "events": "canplay (resolve) | error (reject)"
      },
      
      "changeEnvironment": {
        "function": "setAttribute('environment', `preset: ${envName}`)",
        "none_case": "removeAttribute('environment')"
      }
    },
    
    "vr-controls.js": {
      "purpose": "VR UI panel + 3D controls (mobile/desktop/VR compatible)",
      
      "vr_cursor": {
        "smart_visibility": "Sadece clickable objelere yakla≈üƒ±nca g√∂r√ºn√ºr",
        "events": [
          "raycaster-intersected ‚Üí opacity:0.8",
          "raycaster-intersected-cleared ‚Üí opacity:0"
        ],
        "config": "color:#00FF00, fuse:false, raycaster far:100"
      },
      
      "vr_ui_panel": {
        "position": "config.VRUICONFIG.position (-5, 1.6, -3)",
        "rotation": "(0, 90, 0) - User'a d√∂n√ºk",
        "scale": "0.7",
        
        "components": {
          "title": "VR KONTROL PANELI text",
          "buttons": [
            "PLAY (#4CAF50)",
            "DURDUR (#FF9800)",
            "BITIR (#F44336)",
            "¬±10s seek (#2196F3)",
            "SES¬± (#9C27B0)",
            "SESƒ∞Z (#607D8B)",
            "Screen position (‚Üë‚Üì‚Üê‚Üí‚ü≤) (#00BCD4)",
            "B√úY√úT/K√ú√á√úLT (#795548)"
          ],
          
          "seekbar": {
            "width": "1.8 (VRUICONFIG.seekBarWidth)",
            "components": [
              "Background bar (clickable)",
              "Progress bar (dynamic width)",
              "Time text (current/total)",
              "Volume indicator"
            ],
            "click_handling": "VR + Mouse + Touch support"
          }
        }
      },
      
      "button_creation": {
        "geometry": "a-box (width:0.28, height:0.28, depth:0.05)",
        "text": "a-text child (align:center, width:1.5)",
        "events": [
          "click - VR controller",
          "mousedown - Desktop mouse",
          "touchstart - Mobile touch"
        ],
        "class": "clickable - Raycaster target"
      },
      
      "seekbar_precision": {
        "algorithm": "World-space coordinate calculation",
        "steps": [
          "1. getWorldPosition() - Seekbar world pos",
          "2. intersection.point - Click world pos",
          "3. localClickPoint = clickPoint - seekBarPos",
          "4. applyQuaternion(inverse rotation)",
          "5. relativeX / seekBarWidth ‚Üí percentage",
          "6. clamp(0, 1)",
          "7. seekToPosition(percentage)"
        ],
        "compatibility": [
          "VR: raycaster-intersected event",
          "Desktop: mousedown + THREE.Raycaster",
          "Mobile: touchstart + raycaster calculation"
        ]
      },
      
      "seekbar_update": {
        "interval": "500ms",
        "progress_calculation": "current / duration ‚Üí width",
        "position_calculation": "-width/2 + (width * progress)/2",
        "time_display": "formatTime(current) / formatTime(duration)"
      },
      
      "screen_controls": {
        "moveScreen": {
          "step": "0.5 units",
          "directions": ["up", "down", "left", "right", "forward", "backward"],
          "reset": "position:(0,2,-10), scale:1"
        },
        
        "scaleScreen": {
          "delta": "¬±0.1",
          "range": "0.5 - 3.0",
          "implementation": "setAttribute('scale', `${s} ${s} ${s}`)"
        }
      },
      
      "volume_controls": {
        "adjustVolume": "videoElement.volume ¬± 0.1 (clamp 0-1)",
        "toggleMute": "videoElement.muted = !muted",
        "indicator_update": "#vr-volume-indicator text update"
      },
      
      "formatTime": {
        "format": "M:SS",
        "implementation": "Math.floor(s/60):Math.floor(s%60).padStart(2,'0')"
      }
    },
    
    "styles.css": {
      "purpose": "UI overlay styling + responsive design",
      
      "key_styles": {
        "ui_overlay": {
          "gradient": "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
          "transition": "opacity 0.5s",
          "hidden_state": "opacity:0, pointer-events:none"
        },
        
        "ui_container": {
          "background": "rgba(255,255,255,0.95)",
          "border_radius": "20px",
          "max_height": "90vh",
          "overflow_y": "auto",
          "box_shadow": "0 20px 60px rgba(0,0,0,0.3)"
        },
        
        "buttons": {
          "gradient": "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
          "hover": "translateY(-2px) + box-shadow",
          "variants": {
            "secondary": "#f093fb ‚Üí #f5576c",
            "stop": "#ff9800 ‚Üí #ff5722"
          }
        },
        
        "room_item": {
          "background": "#f8f9fa",
          "border_left": "4px solid #667eea",
          "hover": "translateX(5px) + shadow",
          "cursor": "pointer"
        },
        
        "vr_controls": {
          "position": "fixed bottom:20px left:50% translateX(-50%)",
          "background": "rgba(0,0,0,0.8)",
          "border_radius": "15px",
          "display": "none (visible class ‚Üí block)"
        },
        
        "room_info_display": {
          "position": "fixed top:20px right:20px",
          "background": "rgba(0,0,0,0.8)",
          "color": "white",
          "display": "none (visible class ‚Üí block)"
        },
        
        "responsive": {
          "breakpoint": "768px",
          "changes": [
            "Container padding reduce",
            "Font size reduce",
            "VR controls smaller",
            "Room info smaller"
          ]
        }
      }
    },
    
    "firebase-rules.json": {
      "purpose": "Firebase Realtime Database security rules",
      
      "key_rules": {
        "videoLibrary": {
          "read": "public (true)",
          "write": "authenticated (auth != null)",
          "indexOn": ["addedAt", "url"],
          "validation": {
            "url": "string, 10-2000 chars",
            "title": "string, 2-200 chars",
            "addedAt": "number, < now+1000"
          }
        },
        
        "rooms": {
          "read": "public",
          "indexOn": ["createdAt", "viewers", "isPrivate"],
          
          "owner_transfer": {
            "write": "auth != null && (!data.exists() || data.val() == null || data.val() == auth.uid)",
            "purpose": "Atomic ownership transfer via transaction"
          },
          
          "videoState": {
            "read": "true",
            "write": "auth != null && (controlMode == 'everyone' || owner == auth.uid)",
            "validation": {
              "isPlaying": "boolean",
              "currentTime": "number, 0-86400 (24 hours max)",
              "startTimestamp": "number, now¬±7000ms | null",
              "lastUpdate": "number, < now+1000"
            }
          },
          
          "activeViewers": {
            "read": "true",
            "indexOn": ["timestamp", "lastSeen"],
            "write": "auth.uid == $viewerId (own entry only)",
            "validation": {
              "timestamp": "number, < now+1000",
              "lastSeen": "number, < now+1000",
              "isOwner": "boolean",
              "currentDrift": "number, -30000 to 30000 ms",
              "playbackRate": "number, 0.5-2"
            }
          },
          
          "keyframes": {
            "read": "true",
            "write": "auth != null && owner == auth.uid (owner only)",
            "indexOn": ["timestamp"],
            "validation": {
              "timestamp": "number, now¬±7000ms",
              "currentTime": "number, 0-86400",
              "isPlaying": "boolean",
              "playbackRate": "number, 0.25-4 (optional)",
              "startTimestamp": "number, now¬±7000ms | null (optional)",
              "drift": "number, -30000 to 30000 (optional)"
            }
          },
          
          "urgentUpdates": {
            "read": "true",
            "write": "auth != null && (controlMode == 'everyone' || owner == auth.uid)",
            "indexOn": ["timestamp", "processed"],
            "validation": {
              "action": "string, play|pause|seek",
              "timestamp": "number, now¬±7000ms",
              "processed": "boolean",
              "currentTime": "number, 0-86400 (optional)",
              "startTimestamp": "number, now¬±7000ms | null (optional)",
              "shouldPlay": "boolean (optional)"
            }
          },
          
          "requests": {
            "read": "true",
            "write": "auth != null",
            "indexOn": ["timestamp", "processed"],
            "validation": {
              "userId": "string, == auth.uid",
              "action": "string, play|pause|seek|stop",
              "timestamp": "number, now¬±7000ms",
              "processed": "boolean",
              "params": {
                "currentTime": "number, 0-86400 (optional)",
                "shouldPlay": "boolean (optional)",
                "seconds": "number, -600 to 600 (optional)",
                "percentage": "number, 0-1 (optional)"
              }
            }
          }
        }
      }
    }
  },
  
  "synchronization_deep_dive": {
    "problem_statement": "Ger√ßek zamanlƒ± video senkronizasyonu 100+ ms aƒü gecikmeleriyle",
    
    "solution_architecture": {
      "layer1_clock_sync": {
        "purpose": "T√ºm clientlarƒ±n ortak zaman referansƒ±",
        "method": "RTT-based offset calculation",
        "precision": "¬±50-100ms",
        "refresh": "60 saniyede bir"
      },
      
      "layer2_state_propagation": {
        "videoState": "Ana durum (isPlaying, currentTime, startTimestamp)",
        "urgentUpdates": "Anƒ±nda eylemler (play, pause, seek)",
        "keyframes": "Periyodik kontrol noktalarƒ± (7 saniyede bir)"
      },
      
      "layer3_drift_correction": {
        "detection": "Beklenen zaman vs ger√ßek zaman farkƒ±",
        "tier1": "<0.5s ‚Üí Sadece play/pause",
        "tier2": "0.5-2s ‚Üí Playback rate ayarƒ±",
        "tier3": ">2s ‚Üí Seek required"
      },
      
      "layer4_preload_optimization": {
        "purpose": "Geciken izleyicilerin smooth yakalanmasƒ±",
        "mechanism": "7 saniye √∂nceden ba≈üla, owner'a yeti≈üince play",
        "benefit": "Buffering minimize, user experience improve"
      },
      
      "layer5_pause_sync_v7": {
        "problem": "Pause sƒ±rasƒ±nda herkes farklƒ± pozisyonda",
        "solution": "T√ºm pozisyonlarƒ± topla, minimum'a 4s geri sar",
        "benefit": "Herkes aynƒ± noktadan play, senkron korunur"
      }
    }
  },
  
  "test_scenarios": {
    "scenario1_basic_sync": {
      "steps": [
        "1. Owner odayƒ± olu≈ütur ve videoyu ba≈ülat",
        "2. 3 viewer odaya katƒ±lsƒ±n",
        "3. Her viewer'ƒ±n drift'i izle (activeViewers)",
        "4. Drift ¬±1000ms i√ßinde mi kontrol et"
      ],
      "expected": "T√ºm viewer'lar ¬±1s i√ßinde senkron"
    },
    
    "scenario2_network_lag": {
      "setup": "Chrome DevTools ‚Üí Network ‚Üí Throttling ‚Üí Slow 3G",
      "steps": [
        "1. Yava≈ü baƒülantƒ± ile odaya katƒ±l",
        "2. Video oynarken drift'i g√∂zle",
        "3. Tier2 (playbackRate) veya Tier3 (seek) tetiklenmeli"
      ],
      "expected": "10 saniye i√ßinde senkronize olma"
    },
    
    "scenario3_pause_sync": {
      "steps": [
        "1. 5 viewer'lƒ± odada video oynatƒ±lƒ±yor",
        "2. Owner pause tu≈üuna bassƒ±n",
        "3. reportPosition komutu gelmeli",
        "4. T√ºm viewer'lar pausePosition yaz",
        "5. 1 saniye sonra minimum pozisyon tespit",
        "6. minPos - 4s ‚Üí seekTarget",
        "7. Herkes aynƒ± noktada dursun"
      ],
      "expected": "T√ºm viewer'lar ¬±0.5s i√ßinde aynƒ± frame'de pause"
    },
    
    "scenario4_owner_disconnect": {
      "steps": [
        "1. Owner odayƒ± olu≈ütur",
        "2. 2 viewer katƒ±lsƒ±n",
        "3. Owner tarayƒ±cƒ±yƒ± kapat (disconnect)",
        "4. 15 saniye sonra owner presence timeout",
        "5. attemptOwnerTransfer() tetiklenmeli",
        "6. ƒ∞lk viewer owner olmalƒ±"
      ],
      "expected": "Ownership smooth transfer, video senkron devam"
    },
    
    "scenario5_seek_preload": {
      "steps": [
        "1. Video 100. saniyede oynatƒ±lƒ±yor",
        "2. Owner seek bar'dan 200. saniyeye tƒ±klasƒ±n",
        "3. urgentUpdate {action:'seek', currentTime:200, shouldPlay:true}",
        "4. Viewer'lar 193. saniyeye seek etmeli",
        "5. pause() ve preloadWaiting ba≈ülasƒ±n",
        "6. Owner 200'e ula≈üƒ±nca viewer'lar play etmeli"
      ],
      "expected": "Smooth seek, stutter yok"
    },
    
    "scenario6_mobile_vr": {
      "device": "Android phone + Cardboard/GearVR",
      "steps": [
        "1. Mobil cihazda odaya katƒ±l",
        "2. VR mode'a ge√ß (A-Frame VR button)",
        "3. VR cursor ile UI panelindeki butonlara tƒ±kla",
        "4. Seekbar'ƒ± VR cursor ile kullan",
        "5. Screen pozisyonunu VR'da ayarla"
      ],
      "expected": "T√ºm kontroller mobil VR'da √ßalƒ±≈ümalƒ±"
    },
    
    "scenario7_concurrent_commands": {
      "setup": "2 owner (controlMode:'everyone')",
      "steps": [
        "1. User A play tu≈üuna basƒ±yor",
        "2. 100ms sonra User B pause tu≈üuna basƒ±yor",
        "3. lastProcessedTimestamp ile deduplication",
        "4. En yeni timestamp (pause) kazanmalƒ±"
      ],
      "expected": "Race condition yok, en yeni komut ge√ßerli"
    },
    
    "scenario8_video_library": {
      "steps": [
        "1. Oda olu≈ütur ‚Üí Manuel URL gir",
        "2. saveVideoToLibrary() tetiklenmeli",
        "3. Firebase /videoLibrary'ye yazƒ±lmalƒ±",
        "4. Yeni oda olu≈ütururken dropdown'da g√∂r√ºnmeli",
        "5. Dropdown'dan se√ß ‚Üí URL otomatik doldurulmalƒ±"
      ],
      "expected": "Video library management √ßalƒ±≈üƒ±yor"
    },
    
    "scenario9_subtitle_sync": {
      "steps": [
        "1. SRT dosyasƒ± URL'i gir",
        "2. parseSRT() ile parse edilmeli",
        "3. Video oynatƒ±lƒ±rken altyazƒ± √ßƒ±kmalƒ±",
        "4. Seek yapƒ±nca altyazƒ± sync olmalƒ±"
      ],
      "expected": "Altyazƒ± video ile senkron"
    },
    
    "scenario10_memory_leak": {
      "duration": "30 dakika",
      "steps": [
        "1. Oda olu≈ütur ve katƒ±l",
        "2. 5 dakika izle",
        "3. leaveRoom() ‚Üí lobby",
        "4. Yeni oda olu≈ütur ve katƒ±l",
        "5. 5 kez tekrarla",
        "6. Chrome Task Manager'da memory kullanƒ±mƒ±nƒ± izle"
      ],
      "expected": "Memory leak yok, stabilize kullanƒ±m"
    }
  },
  
  "performance_optimizations": {
    "firebase_writes": [
      "Drift: Sadece ¬±1000ms deƒüi≈üimde yaz",
      "Keyframe: 7 saniye interval (2s ‚Üí 7s)",
      "Old data cleanup: 2 dakika, 30 saniye auto-delete"
    ],
    
    "ui_updates": [
      "updateRoomInfoDisplay: 3 saniye throttle",
      "VR seekbar: 500ms update interval"
    ],
    
    "listener_efficiency": [
      "limitToLast(1) - Sadece en yeni keyframe",
      "limitToLast(5) - Son 5 urgent update",
      "startAt(getServerTime()) - Sadece yeni update'ler"
    ],
    
    "memory_management": [
      "Tracked intervals - clearAllIntervals()",
      "Listener cleanup - off() on leave",
      "DOM cleanup - remove() on leave"
    ]
  },
  
  "edge_cases_handled": {
    "owner_disconnect": "Automatic ownership transfer",
    "network_partition": "Auto-reconnect + state resync",
    "concurrent_commands": "Timestamp-based deduplication",
    "buffer_starvation": "Preload waiting system",
    "mobile_performance": "Optimized update intervals",
    "vr_input_compatibility": "Multi-event handling (click/mouse/touch)"
  },
  
  "deployment_instructions": {
    "firebase_setup": [
      "1. Firebase Console ‚Üí Yeni proje olu≈ütur",
      "2. Realtime Database aktif et (ba≈ülangƒ±√ß: test mode)",
      "3. Authentication ‚Üí Anonymous giri≈ü aktif et",
      "4. firebase-rules.json ‚Üí Database Rules'a yapƒ±≈ütƒ±r",
      "5. config.js ‚Üí firebaseConfig g√ºncelle"
    ],
    
    "hosting": [
      "Firebase Hosting (√∂nerilen)",
      "GitHub Pages",
      "Netlify",
      "Vercel",
      "Herhangi bir static host"
    ],
    
    "ssl_requirement": "HTTPS gerekli (WebRTC + Firebase)",
    
    "cors_note": "Video URL'leri CORS-enabled olmalƒ± veya proxy kullan"
  },
  
  "browser_compatibility": {
    "chrome": "‚úÖ Full support (√∂nerilen)",
    "firefox": "‚úÖ Full support",
    "safari": "‚ö†Ô∏è Partial (iOS autoplay kƒ±sƒ±tlamalarƒ±)",
    "edge": "‚úÖ Full support",
    "mobile_chrome": "‚úÖ Full support",
    "mobile_safari": "‚ö†Ô∏è Partial (VR limited)"
  },
  
  "future_improvements": {
    "suggested_features": [
      "WebRTC peer-to-peer video streaming (Firebase yerine)",
      "Chat system (text/voice)",
      "User avatars in VR space",
      "Playlist support",
      "Recording/replay functionality",
      "Admin dashboard (analytics)"
    ],
    
    "performance_enhancements": [
      "WebSocket fallback (Firebase pahalƒ±)",
      "CDN integration for videos",
      "Adaptive bitrate streaming",
      "Client-side prediction (smoother sync)"
    ]
  },
  
  "common_issues_solutions": {
    "issue_video_not_loading": {
      "causes": [
        "CORS policy (video sunucu CORS disabled)",
        "Invalid URL",
        "Network blocked"
      ],
      "solutions": [
        "CORS proxy kullan (√∂rn: Cloudflare Worker)",
        "Video URL'i test et (direkt browser'da a√ß)",
        "Network console'u kontrol et"
      ]
    },
    
    "issue_desync": {
      "causes": [
        "Clock offset yanlƒ±≈ü",
        "Network lag >1000ms",
        "Firebase quota a≈üƒ±mƒ±"
      ],
      "solutions": [
        "initClockSync() manuel √ßalƒ±≈ütƒ±r",
        "Network throttling kapat",
        "Firebase plan y√ºkselt"
      ]
    },
    
    "issue_vr_controls_not_working": {
      "causes": [
        "Raycaster misconfigured",
        "Clickable class eksik",
        "Cursor invisible"
      ],
      "solutions": [
        "class='clickable' ekle",
        "VR cursor opacity kontrol et",
        "A-Frame console hatalarƒ± kontrol et"
      ]
    }
  },
  
  "code_style_guide": {
    "naming": {
      "functions": "camelCase (playVideo, listenKeyframes)",
      "constants": "UPPERCASE_SNAKE (SYNCDELAY, KEYFRAMEINTERVAL)",
      "global_vars": "camelCase (videoElement, currentRoomData)"
    },
    
    "debugging": {
      "DEBUGMODE": "true/false toggle",
      "console.log_prefix": "Emoji based (üé¨ ‚úÖ ‚ö†Ô∏è ‚ùå)",
      "debugLog_function": "if (DEBUGMODE) wrapper"
    },
    
    "error_handling": {
      "firebase_operations": "try-catch + catch(err => ...)",
      "video_play": ".play().catch(err => console.warn())",
      "promise_chains": ".then().catch()"
    }
  },
  
  "ai_recreation_checklist": [
    "‚úÖ Firebase config + rules setup",
    "‚úÖ Clock sync implementation (RTT algorithm)",
    "‚úÖ Video state management (isPlaying, currentTime, startTimestamp)",
    "‚úÖ Drift calculation + tier-based correction",
    "‚úÖ Keyframe system (owner ‚Üí viewers)",
    "‚úÖ Urgent updates (play, pause, seek)",
    "‚úÖ Preload waiting (7s buffer)",
    "‚úÖ Pause sync v7 (position reporting + rewind)",
    "‚úÖ Buffer preload (pause ‚Üí play smooth)",
    "‚úÖ Owner presence + auto-transfer",
    "‚úÖ VR UI panel (buttons, seekbar)",
    "‚úÖ Multi-input support (VR/mouse/touch)",
    "‚úÖ Seekbar precision (world-space calculation)",
    "‚úÖ Video library management",
    "‚úÖ Subtitle system (SRT parser)",
    "‚úÖ Room creation + listing",
    "‚úÖ Request system (viewer ‚Üí owner)",
    "‚úÖ Keyboard shortcuts",
    "‚úÖ Memory leak prevention",
    "‚úÖ Responsive CSS",
    "‚úÖ Error handling throughout"
  ],
  
  "single_html_generation_guide": {
    "structure": {
      "<!DOCTYPE html>": "HTML5",
      "<head>": [
        "Firebase 9.22.0 CDN (app, database, auth)",
        "A-Frame 1.6.0 CDN",
        "A-Frame environment component 1.3.7 CDN",
        "Inline <style> (styles.css i√ßeriƒüi)",
        "Firebase config inline <script>"
      ],
      "<body>": [
        "UI overlay div structure",
        "VR controls div",
        "Room info div",
        "Sync status div",
        "A-Frame <a-scene>",
        "Inline <script> (t√ºm JS dosyalarƒ± sƒ±rayla)"
      ]
    },
    
    "script_order": [
      "1. config.js",
      "2. ui1.js",
      "3. ui2.js",
      "4. core1.js",
      "5. core2.js",
      "6. core3.js",
      "7. vr-controls.js",
      "8. DOMContentLoaded event listener"
    ],
    
    "minification_notes": [
      "CSS: Whitespace kaldƒ±r, comments kaldƒ±r",
      "JS: Yorumlarƒ± kaldƒ±r (// ve /* */)",
      "HTML: Gereksiz bo≈üluklarƒ± kaldƒ±r",
      "Debug log'larƒ± production'da kaldƒ±rƒ±labilir"
    ]
  }
}