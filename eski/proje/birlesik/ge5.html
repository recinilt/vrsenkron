<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metaverse VR Sinema</title>
    
    <!-- A-Frame (VR Motoru) -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <!-- A-Frame Environment Component (HazÄ±r Ã§evreler iÃ§in) -->
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
    <!-- Tailwind CSS (ArayÃ¼z tasarÄ±mÄ± iÃ§in) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* 2D ArayÃ¼z katmanÄ± VR'Ä±n Ã¼zerinde durmalÄ± */
        #ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 9999;
            pointer-events: none; /* BoÅŸluklara tÄ±klayÄ±nca arkadaki 3D sahne dÃ¶nsÃ¼n */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.8);
            transition: opacity 0.5s;
        }
        
        .interactive {
            pointer-events: auto; /* Butonlara tÄ±klanabilsin */
        }

        .hidden-ui {
            opacity: 0;
            pointer-events: none !important;
        }

        #video-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 20px;
            display: none; /* Sadece owner gÃ¶recek */
            pointer-events: auto;
            z-index: 10000;
        }

        /* VR iÃ§indeyken UI gizleme mantÄ±ÄŸÄ± (BasitÃ§e) */
        .a-enter-vr-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10001;
        }
    </style>
</head>
<body>

    <!-- 2D ARAYÃœZ (GiriÅŸ & Lobi) -->
    <div id="ui-layer">
        <div class="bg-gray-900 p-8 rounded-2xl shadow-2xl border border-purple-500 text-center interactive max-w-md w-full">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 mb-6">
                VR Sinema
            </h1>
            
            <!-- GiriÅŸ EkranÄ± -->
            <div id="login-panel">
                <p class="text-gray-400 mb-4">Anonim olarak baÄŸlanÄ±lÄ±yor...</p>
                <div id="login-status" class="text-yellow-500 animate-pulse">Firebase Bekleniyor...</div>
            </div>

            <!-- Oda SeÃ§imi -->
            <div id="room-panel" class="hidden">
                <input type="text" id="username-input" placeholder="AdÄ±n nedir?" class="w-full p-3 mb-4 rounded bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-purple-500">
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <button onclick="createRoom()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded transition">
                        Oda Kur
                    </button>
                    <button onclick="joinRoomPrompt()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded transition">
                        Odaya KatÄ±l
                    </button>
                </div>
                
                <div class="text-left text-sm text-gray-500 mt-4">
                    <p>ğŸ’¡ <b>Oda Kur:</b> Video kontrolÃ¼ sende olur.</p>
                    <p>ğŸ’¡ <b>KatÄ±l:</b> ArkadaÅŸÄ±nÄ±n Oda ID'sini gir.</p>
                </div>
            </div>

            <!-- Lobi (Oda Ä°Ã§i Bekleme) -->
            <div id="lobby-panel" class="hidden">
                <h2 class="text-2xl text-white mb-2">Sinema Salonu</h2>
                <div class="bg-gray-800 p-2 rounded mb-4 flex items-center justify-between">
                    <span class="text-gray-400 text-xs uppercase tracking-wider">Oda ID</span>
                    <span id="display-room-id" class="text-green-400 font-mono select-all cursor-pointer text-lg">---</span>
                </div>
                
                <div class="text-left bg-gray-800/50 p-3 rounded h-32 overflow-y-auto mb-4 border border-gray-700">
                    <h3 class="text-gray-400 text-xs mb-2">Ä°ZLEYÄ°CÄ°LER (<span id="viewer-count">0</span>)</h3>
                    <ul id="viewer-list" class="text-sm text-white space-y-1">
                        <!-- JS ile dolacak -->
                    </ul>
                </div>

                <button onclick="startCinemaExperience()" class="w-full bg-gradient-to-r from-green-500 to-emerald-700 text-white font-bold py-3 px-4 rounded shadow-lg transform hover:scale-105 transition">
                    SALONA GÄ°R (Video BaÅŸlat)
                </button>
            </div>
        </div>
    </div>

    <!-- Video Kontrolleri (Sadece Owner GÃ¶recek) -->
    <div id="video-controls" class="flex items-center space-x-4">
        <button id="btn-play" class="text-white hover:text-green-400 text-2xl">â–¶</button>
        <button id="btn-pause" class="text-white hover:text-yellow-400 text-2xl hidden">â¸</button>
        <input type="range" id="seek-bar" min="0" value="0" step="0.1" class="w-64 accent-purple-500">
        <span id="time-display" class="text-white font-mono text-sm">00:00</span>
    </div>

    <!-- 3D VR SAHNESÄ° -->
    <a-scene background="color: black" renderer="antialias: true; colorManagement: true;">
        <a-assets>
            <!-- Ã–rnek Film: Big Buck Bunny -->
            <video id="cinema-screen" 
                   src="https://vr-sinema.online/videos/chocolat-cikolata-2000-turkce-dublaj.mp4"
                   crossorigin="anonymous" 
                   playsinline 
                   webkit-playsinline></video>
                   
            <img id="seat-texture" src="https://cdn.aframe.io/examples/ui/scifi/grid.png">
        </a-assets>

        <!-- Ã‡evre (A-Frame Environment) -->
        <a-entity environment="preset: starry; groundColor: #111; grid: none; lighting: point"></a-entity>

        <!-- Sinema Perdesi -->
        <!-- 16:9 oranÄ±nda dev ekran -->
        <a-video src="#cinema-screen" position="0 4 -8" width="16" height="9" material="shader: flat; side: double"></a-video>
        
        <!-- Ekran Ã‡erÃ§evesi ve IÅŸÄ±klandÄ±rma -->
        <a-box position="0 4 -8.1" width="16.5" height="9.5" depth="0.1" color="#333"></a-box>
        <!-- EkranÄ±n yaydÄ±ÄŸÄ± Ä±ÅŸÄ±k efekti -->
        <a-light type="point" color="#FFF" intensity="0.5" position="0 4 -6" distance="20" decay="2"></a-light>

        <!-- Zemin / HalÄ± -->
        <a-plane position="0 0 -4" rotation="-90 0 0" width="20" height="20" color="#222" material="roughness: 1"></a-plane>

        <!-- Basit Koltuklar (Dekoratif) -->
        <a-entity id="seats-container"></a-entity>

        <!-- Kamera / Oyuncu -->
        <a-entity id="rig" position="0 1.6 4">
            <a-entity camera look-controls wasd-controls="acceleration: 20"></a-entity>
            <!-- VR KumandalarÄ± (Varsa) -->
            <a-entity oculus-touch-controls="hand: left"></a-entity>
            <a-entity oculus-touch-controls="hand: right"></a-entity>
            <!-- Laser pointer for UI interaction in VR if needed -->
            <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
        </a-entity>
    </a-scene>

    <!-- FIREBASE & MANTIK KODLARI -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, update, push, child, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // 1. AYARLAR
        const firebaseConfig = {
            apiKey: "AIzaSyC60idSLdAiqAjPWAOMaM3g8LAKPGEUwH8",
            authDomain: "vr-sinema.firebaseapp.com",
            databaseURL: "https://vr-sinema-default-rtdb.firebaseio.com",
            projectId: "vr-sinema",
            storageBucket: "vr-sinema.firebasestorage.app",
            messagingSenderId: "724648238300",
            appId: "1:724648238300:web:dceba8c536e8a5ffd96819"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Global DeÄŸiÅŸkenler
        let currentUser = null;
        let currentRoomId = null;
        let isOwner = false;
        let videoElement = document.getElementById('cinema-screen');
        let syncInterval = null;
        let isSeeking = false; // Slider sÃ¼rÃ¼klenirken sync'i engellemek iÃ§in

        // UI ElemanlarÄ±
        const uiLogin = document.getElementById('login-panel');
        const uiRoom = document.getElementById('room-panel');
        const uiLobby = document.getElementById('lobby-panel');
        const statusText = document.getElementById('login-status');
        const viewerList = document.getElementById('viewer-list');
        const videoControls = document.getElementById('video-controls');
        const btnPlay = document.getElementById('btn-play');
        const btnPause = document.getElementById('btn-pause');
        const seekBar = document.getElementById('seek-bar');
        const timeDisplay = document.getElementById('time-display');

        // 2. AUTHENTICATION (Anonim GiriÅŸ)
        signInAnonymously(auth)
            .then(() => {
                statusText.innerText = "Firebase BaÄŸlandÄ±!";
                statusText.className = "text-green-500 font-bold";
            })
            .catch((error) => {
                statusText.innerText = "Hata: " + error.message;
                statusText.className = "text-red-500 font-bold";
            });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                uiLogin.classList.add('hidden');
                uiRoom.classList.remove('hidden');
            }
        });

        // 3. ODA YÃ–NETÄ°MÄ°
        window.createRoom = async () => {
            const username = document.getElementById('username-input').value || "Misafir " + Math.floor(Math.random()*1000);
            const newRoomRef = push(ref(db, 'rooms'));
            currentRoomId = newRoomRef.key;
            isOwner = true;

            const roomData = {
                owner: currentUser.uid,
                createdAt: serverTimestamp(),
                name: "VR Film OdasÄ±",
                videoState: {
                    isPlaying: false,
                    currentTime: 0
                }
            };

            await set(newRoomRef, roomData);
            enterLobby(username);
        };

        window.joinRoomPrompt = () => {
            const roomId = prompt("LÃ¼tfen Oda ID'sini girin:");
            if (!roomId) return;
            joinRoom(roomId);
        };

        async function joinRoom(roomId) {
            const username = document.getElementById('username-input').value || "Ä°zleyici " + Math.floor(Math.random()*1000);
            
            const snapshot = await get(child(ref(db), `rooms/${roomId}`));
            if (snapshot.exists()) {
                currentRoomId = roomId;
                isOwner = (snapshot.val().owner === currentUser.uid);
                enterLobby(username);
            } else {
                alert("Oda bulunamadÄ±!");
            }
        }

        function enterLobby(username) {
            uiRoom.classList.add('hidden');
            uiLobby.classList.remove('hidden');
            document.getElementById('display-room-id').innerText = currentRoomId;

            // Presence (Ben buradayÄ±m)
            const myPresenceRef = ref(db, `rooms/${currentRoomId}/activeViewers/${currentUser.uid}`);
            set(myPresenceRef, {
                username: username,
                timestamp: serverTimestamp()
            });
            onDisconnect(myPresenceRef).remove(); // Ã‡Ä±kÄ±nca sil

            // Ä°zleyici Listesini Dinle
            onValue(ref(db, `rooms/${currentRoomId}/activeViewers`), (snapshot) => {
                viewerList.innerHTML = "";
                let count = 0;
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    const li = document.createElement('li');
                    li.textContent = `ğŸ‘¤ ${data.username || 'Anonim'}`;
                    viewerList.appendChild(li);
                    count++;
                });
                document.getElementById('viewer-count').innerText = count;
            });

            // Video durumunu dinlemeye baÅŸla (ama henÃ¼z oynatma)
            setupVideoSync();
        }

        // 4. SÄ°NEMA BAÅLATMA & LOGIC
        window.startCinemaExperience = () => {
            // UI KatmanÄ±nÄ± gizle
            document.getElementById('ui-layer').classList.add('hidden-ui');

            // Owner ise kontrolleri gÃ¶ster
            if (isOwner) {
                videoControls.style.display = "flex";
            }

            // TarayÄ±cÄ± otomatik oynatma kilidini aÃ§mak iÃ§in videoyu sessize alÄ±p oynatÄ±p durduruyoruz
            videoElement.play().then(() => {
                videoElement.pause();
                // VeritabanÄ±ndaki duruma gÃ¶re hemen aksiyon alacaÄŸÄ±z
            }).catch(e => console.log("Otomatik oynatma engellendi, etkileÅŸim bekleniyor."));
        };

        function setupVideoSync() {
            const stateRef = ref(db, `rooms/${currentRoomId}/videoState`);

            // Video metadata yÃ¼klendiÄŸinde slider max deÄŸerini ayarla
            videoElement.onloadedmetadata = () => {
                seekBar.max = videoElement.duration;
            };

            // OWNER Ä°ÅLEMLERÄ° (Yazma)
            if (isOwner) {
                // UI Kontrolleri
                btnPlay.onclick = () => {
                    videoElement.play();
                    update(stateRef, { isPlaying: true, currentTime: videoElement.currentTime });
                };
                
                btnPause.onclick = () => {
                    videoElement.pause();
                    update(stateRef, { isPlaying: false, currentTime: videoElement.currentTime });
                };

                seekBar.oninput = () => { isSeeking = true; };
                seekBar.onchange = () => {
                    isSeeking = false;
                    videoElement.currentTime = seekBar.value;
                    update(stateRef, { currentTime: parseFloat(seekBar.value) });
                };

                // Video eventleri (Video Ã¼zerinden kontrol edilirse de yakala)
                videoElement.onplay = () => {
                    updateButtonUI(true);
                    update(stateRef, { isPlaying: true, currentTime: videoElement.currentTime });
                };
                videoElement.onpause = () => {
                    updateButtonUI(false);
                    update(stateRef, { isPlaying: false, currentTime: videoElement.currentTime });
                };

                // Periyodik Sync (Drift'i Ã¶nlemek iÃ§in 2 saniyede bir zamanÄ± gÃ¼ncelle)
                setInterval(() => {
                    if (!videoElement.paused && !isSeeking) {
                        update(stateRef, { currentTime: videoElement.currentTime });
                    }
                }, 2000);
            }

            // HERKES (Okuma & Uygulama)
            onValue(stateRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                // Slider ve SÃ¼re UI gÃ¼ncellemesi (Owner iÃ§in de geÃ§erli, gÃ¶rsel tutarlÄ±lÄ±k)
                if (!isSeeking) {
                    seekBar.value = data.currentTime;
                    timeDisplay.innerText = formatTime(data.currentTime);
                }

                // Sadece Ä°ZLEYÄ°CÄ°LER iÃ§in video kontrol mantÄ±ÄŸÄ± (Owner kendi videosunu kendi yÃ¶netir)
                if (!isOwner) {
                    const drift = Math.abs(videoElement.currentTime - data.currentTime);

                    // 1. Play/Pause Durumu
                    if (data.isPlaying && videoElement.paused) {
                        videoElement.play().catch(e => console.log("Play HatasÄ±:", e));
                    } else if (!data.isPlaying && !videoElement.paused) {
                        videoElement.pause();
                    }

                    // 2. Zaman Senkronizasyonu (Drift Protection)
                    // EÄŸer fark 2 saniyeden bÃ¼yÃ¼kse, direkt atla.
                    if (drift > 2) {
                        console.log("Senkronize ediliyor... Drift:", drift);
                        videoElement.currentTime = data.currentTime;
                    }
                } else {
                    // Owner UI gÃ¼ncellemesi
                    updateButtonUI(data.isPlaying);
                }
            });
        }

        function updateButtonUI(isPlaying) {
            if (isPlaying) {
                btnPlay.classList.add('hidden');
                btnPause.classList.remove('hidden');
            } else {
                btnPlay.classList.remove('hidden');
                btnPause.classList.add('hidden');
            }
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        // --- KOLTUKLARI OLUÅTUR (GÃ¶rsellik) ---
        const seatsContainer = document.getElementById('seats-container');
        for (let i = -2; i <= 2; i++) { // 3 sÄ±ra
            for (let j = -3; j <= 3; j++) { // Her sÄ±rada 7 koltuk
                if (i === 0 && j === 0) continue; // OrtayÄ± boÅŸ bÄ±rak (Kamera iÃ§in)
                const seat = document.createElement('a-box');
                seat.setAttribute('position', `${j * 1.5} 0.5 ${i * 1.5 + 4}`);
                seat.setAttribute('width', '1');
                seat.setAttribute('height', '1');
                seat.setAttribute('depth', '1');
                seat.setAttribute('color', '#550000'); // KÄ±rmÄ±zÄ± koltuklar
                seatsContainer.appendChild(seat);
            }
        }
    </script>
</body>
</html>