<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VR Sinema - Global Sync (20+ iÃ§in)</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>

  <!-- Firebase (compat kolaylÄ±k, Realtime DB) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <style>
    /* Temel stil (azaltÄ±ldÄ± ama fonksiyonel) */
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; overflow: hidden; }
    #ui-overlay { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg,#667eea66,#764ba266); z-index:1000; }
    .ui-container { width: 92%; max-width: 820px; background: rgba(255,255,255,0.98); padding: 24px; border-radius: 12px; box-shadow:0 10px 40px rgba(0,0,0,0.2); overflow:auto; max-height: 90vh;}
    h1{ margin:0 0 8px; color:#333; font-size:1.6rem; text-align:center;}
    label{ display:block; margin-top:12px; font-weight:600; }
    input, select, textarea { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #ddd; box-sizing:border-box; font-size:14px; }
    button{ cursor:pointer; padding:10px 14px; border-radius:8px; border:none; background: linear-gradient(135deg,#667eea,#764ba2); color:white; font-weight:700; margin-top:10px;}
    button.secondary{ background: linear-gradient(135deg,#f093fb,#f5576c); }
    .row{ display:flex; gap:8px; }
    .rooms-list{ margin-top:12px; max-height:220px; overflow:auto; }
    .room-item{ padding:10px; border-radius:8px; background:#f8f9fa; margin-bottom:8px; cursor:pointer; border-left:4px solid #667eea;}
    #vr-controls{ position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:1200; background:rgba(0,0,0,0.75); color:white; padding:10px 14px; border-radius:12px; display:none;}
    #vr-controls.visible{ display:block; }
    #sync-status{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.85); color:white; padding:14px 18px; border-radius:10px; z-index:2000; display:none;}
    #room-info-display{ position:fixed; top:18px; right:18px; background:rgba(0,0,0,0.75); color:white; padding:10px 14px; border-radius:10px; display:none; z-index:1200;}
    @media (max-width:720px){ .row{ flex-direction:column; } }
  </style>
</head>
<body>
  <div id="ui-overlay">
    <div class="ui-container">
      <h1>ğŸ¬ VR Sinema â€” Global Sync</h1>

      <label>Oda AdÄ±</label>
      <input id="room-name-input" placeholder="Oda AdÄ± (Ã¶r: AkÅŸam Film)" />

      <label>Video URL (mp4/webm doÄŸrudan link veya Google Drive paylaÅŸÄ±m linki)</label>
      <input id="video-url-input" placeholder="https://...video.mp4 veya drive.google.com/..." />

      <label>AltyazÄ± URL (.srt) â€” isteÄŸe baÄŸlÄ±</label>
      <input id="subtitle-url-input" placeholder="https://..../sub.srt (CORS aÃ§Ä±k olmalÄ±)" />

      <div class="row">
        <div style="flex:1">
          <label>Ortam</label>
          <select id="environment-select">
            <option value="default" selected>Klasik</option>
            <option value="forest">Orman</option>
            <option value="starry">YÄ±ldÄ±zlÄ±</option>
            <option value="none">OrtamsÄ±z</option>
          </select>
        </div>
        <div style="width:160px">
          <label>Ekran TÃ¼rÃ¼</label>
          <select id="screen-size">
            <option value="flat" selected>DÃ¼z</option>
            <option value="360">360Â°</option>
            <option value="180">180Â°</option>
          </select>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>Kontrol</label>
        <label><input type="radio" name="control-mode" value="owner" checked/> Sadece Sahip</label>
        <label><input type="radio" name="control-mode" value="everyone" /> Herkes</label>
      </div>

      <div class="row">
        <button onclick="createRoom()">ğŸš€ Oda OluÅŸtur & KatÄ±l</button>
        <button class="secondary" onclick="listRooms()">ğŸ”„ OdalarÄ± Yenile</button>
      </div>

      <h3 style="margin-top:18px">AÃ§Ä±k Odalar</h3>
      <div id="rooms-list" class="rooms-list">YÃ¼kleniyor...</div>

      <p style="margin-top:8px; font-size:13px; color:#444;">
        Not: DoÄŸrudan video linkleri (mp4/webm) ile VR sahnede gerÃ§ek zamanlÄ± texture Ã§alÄ±ÅŸÄ±r. YouTube videolarÄ± iframe ile aÃ§Ä±lÄ±r (video-texture desteklemez).
      </p>
    </div>
  </div>

  <div id="sync-status"></div>

  <div id="room-info-display">
    <div><strong id="room-name">-</strong></div>
    <div>ğŸ‘¥ <span id="viewers-count">0</span> kiÅŸi</div>
    <div>ğŸ® <span id="control-mode">-</span></div>
  </div>

  <div id="vr-controls">
    <button onclick="playVideo()">â–¶ï¸</button>
    <button onclick="pauseVideo()">â¸ï¸</button>
    <button onclick="seekVideo(-10)">âª -10s</button>
    <button onclick="seekVideo(10)">â© +10s</button>
    <button onclick="stopVideo()" style="background:#ff7043">â¹ï¸</button>
  </div>

  <a-scene>
    <a-entity id="camera-rig">
      <a-camera>
        <a-cursor color="#0f0"></a-cursor>
      </a-camera>
    </a-entity>

    <a-entity id="video-screen" position="0 2 -6" visible="false"></a-entity>
    <a-entity environment="preset: default; lighting: distant;"></a-entity>
  </a-scene>

<script>
/*
  GeliÅŸtirilmiÅŸ tek sayfa VR Senkron UygulamasÄ±
  - Firebase Realtime DB (compat)
  - Hibrit sync: owner keyframes + urgent updates
  - Ã‡oklu saat ping (median) ile clock sync
  - Owner election (basit)
  - Video: HTML5 <video> (mp4/webm) Ã¶ncelikli; YouTube iÃ§in 2D fallback
*/

/* ===========================
   Firebase KonfigÃ¼rasyonu
   (Senin orijinal config'i kullandÄ±m; kendi projeni koyabilirsin)
   =========================== */
const firebaseConfig = {
  apiKey: "AIzaSyC60idSLdAiqAjPWAOMaM3g8LAKPGEUwH8",
  authDomain: "vr-sinema.firebaseapp.com",
  databaseURL: "https://vr-sinema-default-rtdb.firebaseio.com",
  projectId: "vr-sinema",
  storageBucket: "vr-sinema.firebasestorage.app",
  messagingSenderId: "724648238300",
  appId: "1:724648238300:web:dceba8c536e8a5ffd96819"
};
firebase.initializeApp(firebaseConfig);

/* ===========================
   Sabitler ve Ayarlar
   =========================== */
const SYNC_DELAY = 10000;          // 10s (play/seek iÃ§in)
const KEYFRAME_INTERVAL = 7000;    // 7s (owner keyframe)
const CLOCK_SYNC_INTERVAL = 60000; // 60s (saat yeniden sync)
const SEEK_DEBOUNCE_DELAY = 2000;  // 2s
const SEEK_REWIND_SECONDS = 4;     // 4s rewind after seek
const SMOOTH_THRESHOLD = 1500;     // 1.5s tolerans (ms)
const CLOCK_SYNC_SAMPLES = 5;      // median iÃ§in kaÃ§ sample
const KEYFRAME_TTL_MS = 5 * 60 * 1000; // 5 dakika sonra temizle

const ENVIRONMENTS = {
  'none': { name: 'OrtamsÄ±z', preset: null },
  'default': { name: 'Klasik', preset: 'default' },
  'forest': { name: 'Orman', preset: 'forest' },
  'starry': { name: 'YÄ±ldÄ±z', preset: 'starry' }
};

const VIDEO_SERVICES = {
  youtube: {
    pattern: /(youtu\.be\/|youtube\.com\/(watch\?v=|embed\/|v\/|shorts\/))([\w-]{11})/,
    transform: (m) => `https://www.youtube.com/watch?v=${m[3]}`
  },
  googledrive: {
    pattern: /drive\.google\.com\/(?:file\/d\/|open\?id=)([a-zA-Z0-9_-]+)/,
    transform: (m) => `https://mefeypublicv2.recepyeni.workers.dev/?url=${encodeURIComponent('https://drive.google.com/uc?export=download&id=' + m[1])}`
  },
  direct: {
    pattern: /\.(mp4|webm|ogg|mov|m3u8|ts)(\?|$)/i,
    transform: (url) => url
  }
};

/* ===========================
   Global deÄŸiÅŸkenler
   =========================== */
const database = firebase.database();
const auth = firebase.auth();
const roomsRef = database.ref('rooms');

let roomRef = null;
let currentRoomId = null;
let currentRoomData = null;
let isRoomOwner = false;

let clockOffset = 0;         // ms (clientTime + offset = approx serverTime)
let clockSyncReady = false;
let keyframeIntervalId = null;
let lastKeyframeTimestamp = 0;
let syncTimeout = null;
let lastSeekTime = 0;
let seekDebounceTimeout = null;
let videoElement = null;     // HTMLVideoElement when used
let subtitleData = null;
let subtitleElement = null;
let screenPosition = { x:0, y:2, z:-6 };

/* ===========================
   YardÄ±mcÄ± fonksiyonlar
   =========================== */
function log(...args){ console.log('[VRSync]',...args); }
function showSyncStatus(msg, timeout=3000){
  const el = document.getElementById('sync-status');
  if(!el) return;
  el.textContent = msg;
  el.style.display = 'block';
  clearTimeout(el._hideTO);
  el._hideTO = setTimeout(()=> el.style.display='none', timeout);
}

function escapeHtml(text){
  const d = document.createElement('div'); d.textContent = text; return d.innerHTML;
}

function formatTime(s){
  if(!isFinite(s) || s<0) return '0:00';
  const m = Math.floor(s/60); const sec = Math.floor(s%60);
  return `${m}:${sec.toString().padStart(2,'0')}`;
}

/* ===========================
   Video servis tespiti
   =========================== */
function detectVideoService(url){
  if(!url) return 'unknown';
  for(const [k,v] of Object.entries(VIDEO_SERVICES)){
    if(v.pattern.test(url)) return k;
  }
  return 'direct';
}

function getVideoUrl(inputUrl){
  if(!inputUrl) return null;
  const service = detectVideoService(inputUrl);
  if(service === 'direct') return inputUrl;
  const cfg = VIDEO_SERVICES[service];
  const m = inputUrl.match(cfg.pattern);
  if(m) return cfg.transform(m);
  return inputUrl;
}

/* ===========================
   Saat senkronizasyonu (median multiple samples)
   =========================== */
async function syncClockMulti(){
  if(!roomRef) return;
  const samples = [];
  for(let i=0;i<CLOCK_SYNC_SAMPLES;i++){
    const t1 = Date.now();
    await roomRef.child('serverPing').set(firebase.database.ServerValue.TIMESTAMP);
    // small delay to ensure write hits
    const snap = await roomRef.child('serverPing').once('value');
    const t4 = Date.now();
    const t2 = snap.val();
    if(!t2) continue;
    const rtt = t4 - t1;
    const offsetSample = (t2 + rtt/2) - t4; // estimated server - client
    samples.push(offsetSample);
    await new Promise(r => setTimeout(r, 60)); // hafif gecikme
  }
  if(samples.length === 0) return;
  samples.sort((a,b)=>a-b);
  const median = samples[Math.floor(samples.length/2)];
  // exponential smoothing
  clockOffset = clockOffset === 0 ? median : (clockOffset*0.7 + median*0.3);
  clockSyncReady = true;
  log('â° Clock offset (ms):', Math.round(clockOffset));
  return clockOffset;
}

function getAdjustedTime(){
  return clockSyncReady ? Date.now() + clockOffset : Date.now();
}

/* ===========================
   Keyframe yÃ¶netimi
   =========================== */
function sendKeyframe(){
  if(!isRoomOwner || !videoElement || !roomRef) return;
  const ts = Math.floor(getAdjustedTime());
  const kf = {
    timestamp: ts,
    currentTime: videoElement.currentTime,
    isPlaying: !videoElement.paused,
    playbackRate: videoElement.playbackRate || 1,
    startTimestamp: !videoElement.paused ? getAdjustedTime() : null
  };
  // id by timestamp to help TTL purge
  roomRef.child('keyframes').child(String(ts)).set(kf).catch(e=>log('kf set err',e));
  log('ğŸ“¸ Keyframe gÃ¶nderildi', kf.currentTime.toFixed(2),'s');
}

function startKeyframeLoop(){
  if(keyframeIntervalId) clearInterval(keyframeIntervalId);
  if(isRoomOwner) {
    sendKeyframe(); // immediate
    keyframeIntervalId = setInterval(sendKeyframe, KEYFRAME_INTERVAL);
    // Purge old keyframes every minute
    setInterval(()=>{
      const cutoff = Date.now() - KEYFRAME_TTL_MS;
      roomRef.child('keyframes').orderByChild('timestamp').endAt(cutoff).once('value',(snap)=>{
        snap.forEach(child => child.ref.remove());
      });
    }, 60000);
  }
}

function listenToKeyframes(){
  if(!roomRef) return;
  roomRef.child('keyframes').on('child_added', (snap)=>{
    const kf = snap.val();
    if(!kf || !videoElement) return;
    if(kf.timestamp <= lastKeyframeTimestamp) return;
    const now = getAdjustedTime();
    if(kf.isPlaying && kf.startTimestamp){
      const elapsed = (now - kf.startTimestamp) / 1000;
      const predicted = kf.currentTime + elapsed;
      const drift = Math.abs(videoElement.currentTime - predicted) * 1000;
      if(drift < SMOOTH_THRESHOLD){
        log('âœ… Smooth (drift)', (drift/1000).toFixed(3),'s');
        lastKeyframeTimestamp = kf.timestamp;
        return;
      } else {
        // dÃ¼zeltme
        try {
          videoElement.currentTime = predicted;
          log('ğŸ”„ Predictive correction to', predicted.toFixed(2),'s (drift', (drift/1000).toFixed(2),'s)');
        } catch(e){
          log('seek error', e);
        }
      }
    }
    if(kf.isPlaying && videoElement.paused){
      videoElement.play().catch(e=>log('autoplay block',e));
    } else if(!kf.isPlaying && !videoElement.paused){
      videoElement.pause();
    }
    lastKeyframeTimestamp = kf.timestamp;
  });
  log('âœ“ Keyframe listener aktif');
}

/* ===========================
   Urgent updates (play/pause/seek)
   =========================== */
function sendUrgentUpdate(action, params = {}){
  if(!roomRef) return;
  const pushRef = roomRef.child('urgentUpdates').push();
  pushRef.set({
    action,
    timestamp: getAdjustedTime(),
    ...params,
    processed: false
  }).catch(e=>log('urgent push err',e));
  log('âš¡ Urgent send', action, params);
}

function listenToUrgentUpdates(){
  if(!roomRef) return;
  roomRef.child('urgentUpdates').on('child_added', (snap)=>{
    const upd = snap.val();
    if(!upd || !videoElement) return;
    if(upd.processed) return;
    snap.ref.update({ processed: true });
    handleUrgentUpdate(upd);
    // kÄ±sa sÃ¼re sonra temizle
    setTimeout(()=> snap.ref.remove(), 10000);
  });
  log('âœ“ Urgent listener aktif');
}

function handleUrgentUpdate(upd){
  const now = getAdjustedTime();
  if(upd.action === 'play' && upd.startTimestamp !== undefined){
    const wait = upd.startTimestamp - now;
    try {
      if(Math.abs(videoElement.currentTime - upd.currentTime) > 0.5) videoElement.currentTime = upd.currentTime;
    } catch(e){ log('seek err', e); }
    if(wait > 0){
      videoElement.pause();
      if(syncTimeout) clearTimeout(syncTimeout);
      syncTimeout = setTimeout(()=> videoElement.play().catch(e=>log('autoplay',e)), wait);
      showSyncStatus('â±ï¸ ' + (wait/1000).toFixed(1) + 's sonra baÅŸlÄ±yor');
    } else {
      videoElement.play().catch(e=>log('autoplay',e));
    }
    log('â–¶ Urgent play scheduled', upd.currentTime);
  } else if(upd.action === 'pause'){
    try {
      if(upd.currentTime !== undefined) videoElement.currentTime = upd.currentTime;
    } catch(e){}
    videoElement.pause();
    log('â¸ Urgent pause');
  } else if(upd.action === 'seek'){
    try {
      videoElement.currentTime = upd.currentTime;
    } catch(e){}
    if(upd.shouldPlay && upd.startTimestamp){
      const wait = Math.max(0, upd.startTimestamp - now);
      if(wait > 0){
        videoElement.pause();
        if(syncTimeout) clearTimeout(syncTimeout);
        syncTimeout = setTimeout(()=> videoElement.play().catch(e=>log('autoplay',e)), wait);
        showSyncStatus('â±ï¸ ' + (wait/1000).toFixed(1) + 's sonra devam');
      } else {
        videoElement.play().catch(e=>log('autoplay',e));
      }
    }
    log('â© Urgent seek to', upd.currentTime);
  }
}

/* ===========================
   Control requests (non-owner -> owner)
   =========================== */
function sendControlRequest(action, params = {}){
  if(!roomRef) return;
  const user = auth.currentUser;
  const uid = user ? user.uid : 'anon';
  roomRef.child('requests').push().set({
    userId: uid,
    action,
    params,
    timestamp: getAdjustedTime(),
    processed: false
  });
  log('ğŸ“¨ Control request', action);
}

function listenToControlRequests(){
  if(!isRoomOwner || !roomRef) return;
  roomRef.child('requests').on('child_added', snap => {
    const req = snap.val();
    if(!req || req.processed) return;
    log('ğŸ“¬ Owner got request', req.action);
    processControlRequest(req);
    snap.ref.update({ processed: true });
    setTimeout(()=> snap.ref.remove(), 10000);
  });
}

function processControlRequest(req){
  if(!videoElement) return;
  if(req.action === 'play') playVideo();
  else if(req.action === 'pause') pauseVideo();
  else if(req.action === 'seek' && req.params.currentTime !== undefined){
    videoElement.currentTime = req.params.currentTime;
    if(req.params.shouldPlay) playVideo();
  }
}

/* ===========================
   Initial sync (joiner iÃ§in)
   =========================== */
function performInitialSync(){
  if(!roomRef || !videoElement) return;
  roomRef.child('keyframes').limitToLast(1).once('value', snap => {
    if(!snap.exists()) return;
    const kf = Object.values(snap.val())[0];
    if(!kf) return;
    videoElement.addEventListener('loadedmetadata', ()=>{
      const now = getAdjustedTime();
      if(kf.isPlaying && kf.startTimestamp){
        const elapsed = (now - kf.startTimestamp) / 1000;
        const predicted = kf.currentTime + elapsed;
        try {
          videoElement.currentTime = predicted;
          videoElement.play().catch(e=>log('autoplay',e));
        } catch(e){ log('initial seek err', e); }
      } else {
        try { videoElement.currentTime = kf.currentTime; } catch(e){}
      }
    }, { once:true });
  });
}

/* ===========================
   High-level init for hybrid sync
   =========================== */
function initHybridSync(){
  if(!roomRef || !videoElement) return;
  log('ğŸš€ Hibrit senkron baÅŸlatÄ±lÄ±yor...');
  syncClockMulti();
  setInterval(()=> syncClockMulti(), CLOCK_SYNC_INTERVAL);
  listenToKeyframes();
  listenToUrgentUpdates();
  if(isRoomOwner){
    startKeyframeLoop();
    listenToControlRequests();
    // purge old urgent/requests periodically
    setInterval(()=>{
      const cutoff = Date.now() - 60000;
      roomRef.child('urgentUpdates').orderByChild('timestamp').endAt(cutoff).once('value',(snap)=> snap.forEach(c=> c.ref.remove()));
      roomRef.child('requests').orderByChild('timestamp').endAt(cutoff).once('value',(snap)=> snap.forEach(c=> c.ref.remove()));
    }, 30000);
  }
  performInitialSync();
  log('âœ“ Hibrit hazÄ±r');
}

/* ===========================
   UI / Oda YÃ¶netimi
   =========================== */
function createRoom(){
  const name = document.getElementById('room-name-input').value.trim();
  const videoUrlInput = document.getElementById('video-url-input').value.trim();
  const subtitleUrl = document.getElementById('subtitle-url-input').value.trim();
  const env = document.getElementById('environment-select').value;
  const screenSize = document.getElementById('screen-size').value;
  const controlMode = document.querySelector('input[name="control-mode"]:checked').value;

  if(!name || !videoUrlInput){ alert('Oda adÄ± ve video URL gerekli'); return; }

  auth.signInAnonymously().then(() => {
    const uid = auth.currentUser.uid;
    const newRef = roomsRef.push();
    const data = {
      name,
      videoUrl: videoUrlInput,
      subtitleUrl: subtitleUrl || null,
      environment: env,
      screenSize,
      owner: uid,
      controlMode,
      viewers: 1,
      createdAt: Date.now(),
      videoState: {
        isPlaying: false, currentTime: 0, startTimestamp: null, lastUpdate: Date.now()
      }
    };
    newRef.set(data).then(()=>{
      joinRoom(newRef.key, null);
    });
  }).catch(e=> alert('Auth err: ' + e.message));
}

function joinRoom(roomId, password=null){
  roomsRef.child(roomId).once('value').then(snap=>{
    const room = snap.val();
    if(!room){ alert('Oda bulunamadÄ±'); return; }
    // private handling could be added
    auth.signInAnonymously().then(()=>{
      const uid = auth.currentUser.uid;
      currentRoomId = roomId;
      currentRoomData = room;
      roomRef = roomsRef.child(roomId);
      isRoomOwner = (room.owner === uid);

      // increment viewers safely
      roomRef.child('viewers').transaction(c => (c||0)+1);

      // presence
      const presenceRef = database.ref('.info/connected');
      presenceRef.on('value', snapCon=>{
        if(snapCon.val()){
          const myPresence = roomRef.child('activeViewers').child(uid);
          myPresence.onDisconnect().remove();
          myPresence.set({ timestamp: Date.now(), isOwner: isRoomOwner });
          roomRef.child('viewers').onDisconnect().set(firebase.database.ServerValue.increment(-1));
          if(isRoomOwner) roomRef.child('owner').onDisconnect().remove();
        }
      });

      // owner election: if owner missing, select first active viewer
      roomRef.child('owner').on('value', v=>{
        if(!v.exists()){
          // try electing: pick earliest activeViewers
          roomRef.child('activeViewers').orderByChild('timestamp').limitToFirst(1).once('value', snapAv=>{
            snapAv.forEach(child => {
              // promote this uid
              roomRef.child('owner').transaction(curr => curr || child.key);
            });
          });
        }
      });

      currentRoomData = room;
      const url = getVideoUrl(room.videoUrl);
      setupVideo(url, room.screenSize);
      if(room.subtitleUrl) loadSubtitle(room.subtitleUrl);
      createVRUIPanel();
      document.getElementById('ui-overlay').classList.add('hidden');
      document.getElementById('vr-controls').classList.add('visible');
      document.getElementById('room-info-display').style.display = 'block';
      updateRoomInfoDisplay();

      if(typeof initHybridSync === 'function') initHybridSync();
      log('âœ“ Joined room', roomId, 'owner?', isRoomOwner);
    });
  });
}

function listRooms(){
  roomsRef.once('value').then(snap=>{
    const rooms = snap.val();
    const list = document.getElementById('rooms-list');
    list.innerHTML = '';
    if(!rooms){ list.innerHTML = '<p>AÃ§Ä±k oda yok</p>'; return; }
    let count = 0;
    Object.entries(rooms).forEach(([rid, r])=>{
      // skip private if any - (we don't store password in this version)
      const div = document.createElement('div');
      div.className = 'room-item';
      div.innerHTML = `<div style="font-weight:700">${escapeHtml(r.name)}</div>
        <div style="font-size:13px; color:#666">ğŸ‘¥ ${r.viewers||0} | ğŸ® ${r.controlMode==='owner'?'Sahip':'Herkes'} | ${ENVIRONMENTS[r.environment]?.name||'Bilinmiyor'}</div>`;
      div.onclick = ()=> joinRoom(rid);
      list.appendChild(div);
      count++;
    });
    if(count===0) list.innerHTML = '<p>AÃ§Ä±k oda yok</p>';
  });
}

/* ===========================
   Video / texture setup
   - Sadece HTML5 <video> (mp4/webm) Ã¼Ã§gen texture ile Ã§alÄ±ÅŸÄ±r
   - YouTube => 2D fallback (popup)
   =========================== */
function setupVideo(videoUrl, screenSize){
  if(!videoUrl){ alert('Video URL hatasÄ±'); return; }
  const service = detectVideoService(videoUrl);
  if(service === 'youtube'){
    alert('YouTube video: VR texture olarak Ã§alÄ±ÅŸmaz. Video, yeni sekmede aÃ§Ä±lacak. (DoÄŸrudan mp4 Ã¶nerilir.)');
    window.open(videoUrl, '_blank');
    return;
  }
  // videoUrl muhtemelen mp4 veya proxy edilmiÅŸ drive linki
  setupVideoTexture(videoUrl, screenSize);
  // environment
  const scene = document.querySelector('a-scene');
  const env = scene.querySelector('[environment]');
  if(env) env.setAttribute('environment', { preset: currentRoomData.environment || 'default', lighting: 'distant' });
}

function setupVideoTexture(videoUrl, screenSize){
  const scene = document.querySelector('a-scene');
  const screen = document.getElementById('video-screen');
  const sizes = { 'flat': {w:16,h:9}, '360': {w:100,h:100}, '180': {w:50,h:50} };
  const size = sizes[screenSize] || sizes['flat'];

  // geometry setup
  if(screenSize === '360'){
    screen.setAttribute('geometry','primitive:sphere; radius:50');
    screen.setAttribute('material','side:back');
    screen.setAttribute('scale','-1 1 1');
  } else if(screenSize === '180'){
    screen.setAttribute('geometry','primitive:sphere; radius:25; thetaLength:180');
    screen.setAttribute('material','side:back');
    screen.setAttribute('scale','-1 1 1');
  } else {
    screen.setAttribute('geometry', `primitive:plane; width:${size.w}; height:${size.h}`);
    screen.removeAttribute('scale');
  }

  // ensure a-assets exists
  let assets = document.querySelector('a-assets');
  if(!assets){
    assets = document.createElement('a-assets');
    scene.appendChild(assets);
  }

  // remove old video if varsa
  const oldVideo = document.getElementById('video-src');
  if(oldVideo){
    try{ oldVideo.pause(); }catch(e){}
    oldVideo.remove();
  }

  // create new video element
  const video = document.createElement('video');
  video.id = 'video-src';
  video.crossOrigin = 'anonymous';
  video.preload = 'metadata';
  video.loop = false;
  video.playsInline = true;
  video.muted = false;
  video.style.display = 'none';
  video.src = videoUrl;
  assets.appendChild(video);

  // event handlers
  video.addEventListener('loadedmetadata', ()=> {
    log('âœ“ Video metadata loaded:', video.duration ? video.duration.toFixed(1) + 's' : 'unknown');
  });
  video.addEventListener('canplay', ()=> {
    log('âœ“ Video canplay');
    screen.setAttribute('visible', 'true');
  });
  video.addEventListener('error', (e) => {
    console.error('Video load error', e);
    alert('Video yÃ¼klenemedi (CORS / kaynak hatasÄ± olabilir).');
  });

  videoElement = video;
  // set as texture
  screen.setAttribute('src', '#video-src');

  // subtitle updater
  startSubtitleUpdate();
}

/* ===========================
   Subtitle (.srt) parse & render
   =========================== */
function loadSubtitle(url){
  if(!url) return;
  fetch(url).then(r => r.text()).then(text=>{
    subtitleData = parseSRT(text);
    startSubtitleUpdate();
    log('âœ“ AltyazÄ± yÃ¼klendi', subtitleData.length,'satÄ±r');
  }).catch(e=> log('subtitle load err',e));
}

function parseSRT(srt){
  const subs = [];
  const blocks = srt.replace(/\r/g,'').trim().split(/\n\s*\n/);
  blocks.forEach(b=>{
    const lines = b.split('\n').map(l=>l.trim());
    if(lines.length>=2){
      const time = lines[1];
      const m = time.match(/(\d{2}):(\d{2}):(\d{2}),(\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2}),(\d{3})/);
      if(m){
        const s = (+m[1])*3600 + (+m[2])*60 + (+m[3]) + (+m[4])/1000;
        const e = (+m[5])*3600 + (+m[6])*60 + (+m[7]) + (+m[8])/1000;
        subs.push({ start: s, end: e, text: lines.slice(2).join('\n') });
      }
    }
  });
  return subs;
}

function startSubtitleUpdate(){
  if(!subtitleData) return;
  const scene = document.querySelector('a-scene');
  if(!subtitleElement){
    subtitleElement = document.createElement('a-entity');
    subtitleElement.setAttribute('id','subtitle');
    subtitleElement.setAttribute('text','value:; align:center; width:20; color:#FFF;');
    subtitleElement.setAttribute('position','0 0 -5');
    subtitleElement.setAttribute('visible','false');
    scene.appendChild(subtitleElement);
  }
  // interval
  if(subtitleElement._interval) clearInterval(subtitleElement._interval);
  subtitleElement._interval = setInterval(()=>{
    if(!videoElement || !subtitleData) return;
    const t = videoElement.currentTime;
    const sub = subtitleData.find(s => t >= s.start && t <= s.end);
    if(sub){
      subtitleElement.setAttribute('text', 'value', sub.text);
      subtitleElement.setAttribute('visible','true');
    } else {
      subtitleElement.setAttribute('visible','false');
    }
  }, 150);
}

/* ===========================
   VR UI Panel (A-Frame)
   =========================== */
const VR_UI_CONFIG = { position:{x:-2,y:1.6,z:-2}, rotation:{x:0,y:60,z:0}, buttonSize:0.25, seekBarWidth:1.4 };

function createVRUIPanel(){
  const scene = document.querySelector('a-scene');
  const cameraRig = document.querySelector('#camera-rig');
  if(document.querySelector('#vr-ui-panel')) return;

  const panel = document.createElement('a-entity');
  panel.setAttribute('id','vr-ui-panel');
  panel.setAttribute('position', `${VR_UI_CONFIG.position.x} ${VR_UI_CONFIG.position.y} ${VR_UI_CONFIG.position.z}`);
  panel.setAttribute('rotation', `${VR_UI_CONFIG.rotation.x} ${VR_UI_CONFIG.rotation.y} ${VR_UI_CONFIG.rotation.z}`);

  const bg = document.createElement('a-plane');
  bg.setAttribute('width','2.2'); bg.setAttribute('height','2.4'); bg.setAttribute('color','#111'); bg.setAttribute('opacity','0.9');
  panel.appendChild(bg);

  const title = document.createElement('a-text');
  title.setAttribute('value','KONTROL'); title.setAttribute('align','center'); title.setAttribute('width','1.8');
  title.setAttribute('position','0 1 0.01'); title.setAttribute('color','#0f0');
  panel.appendChild(title);

  const addBtn = (x,y,label,fn,size=VR_UI_CONFIG.buttonSize)=>{
    const btn = document.createElement('a-entity'); btn.setAttribute('position', `${x} ${y} 0.02`);
    const circle = document.createElement('a-circle'); circle.setAttribute('radius', (size/2).toString()); circle.setAttribute('color','#44f');
    circle.setAttribute('class','clickable'); btn.appendChild(circle);
    const text = document.createElement('a-text'); text.setAttribute('value', label); text.setAttribute('align','center'); text.setAttribute('width', size*2); text.setAttribute('position','0 0 0.01');
    text.setAttribute('color','#fff'); btn.appendChild(text);
    circle.addEventListener('mouseenter', ()=>{ circle.setAttribute('color','#66f'); circle.setAttribute('radius', (size/2)*1.1); });
    circle.addEventListener('mouseleave', ()=>{ circle.setAttribute('color','#44f'); circle.setAttribute('radius', (size/2)); });
    circle.addEventListener('click', fn);
    return btn;
  };

  const screenBtns = [
    {x:0, y:0.9, l:'â†‘', a:()=> moveScreen('up')},
    {x:0, y:0.3, l:'â†“', a:()=> moveScreen('down')},
    {x:-0.45, y:0.6, l:'â†', a:()=> moveScreen('left')},
    {x:0.45, y:0.6, l:'â†’', a:()=> moveScreen('right')},
    {x:-0.9, y:0.6, l:'+', a:()=> moveScreen('forward')},
    {x:0.9, y:0.6, l:'-', a:()=> moveScreen('backward')},
    {x:0, y:-0.1, l:'âŸ²', a:()=> moveScreen('reset')}
  ];
  screenBtns.forEach(b=> panel.appendChild(addBtn(b.x, b.y, b.l, b.a)));

  const videoBtns = [
    {x:-0.55, y:-0.9, l:'â®œ', a:()=> seekVideo(-10)},
    {x:-0.25, y:-0.9, l:'â–¶/||', a:()=> { if(videoElement) videoElement.paused ? playVideo() : pauseVideo(); }},
    {x:0.05, y:-0.9, l:'â– ', a:()=> stopVideo()},
    {x:0.35, y:-0.9, l:'â®', a:()=> seekVideo(10)}
  ];
  videoBtns.forEach(b=> panel.appendChild(addBtn(b.x, b.y, b.l, b.a, 0.27)));

  // seek bar
  const seekBar = document.createElement('a-entity'); seekBar.setAttribute('position','0 -1.45 0.02');
  const bgBar = document.createElement('a-plane'); bgBar.setAttribute('width', VR_UI_CONFIG.seekBarWidth); bgBar.setAttribute('height','0.12'); bgBar.setAttribute('color','#555'); bgBar.setAttribute('class','clickable');
  bgBar.addEventListener('click', (evt)=> {
    if(!videoElement || !videoElement.duration) return;
    const intersection = evt.detail.intersection; if(!intersection) return;
    const local = intersection.point;
    const worldPos = new THREE.Vector3(); bgBar.object3D.getWorldPosition(worldPos);
    const relativeX = local.x - worldPos.x;
    const percentage = (relativeX + VR_UI_CONFIG.seekBarWidth/2) / VR_UI_CONFIG.seekBarWidth;
    const clamped = Math.max(0, Math.min(1, percentage));
    seekToPosition(clamped);
  });
  seekBar.appendChild(bgBar);

  const progressBar = document.createElement('a-plane'); progressBar.setAttribute('id','vr-progress-bar'); progressBar.setAttribute('width','0'); progressBar.setAttribute('height','0.12'); progressBar.setAttribute('color','#0f0'); progressBar.setAttribute('position', `${-VR_UI_CONFIG.seekBarWidth/2} 0 0.01`);
  seekBar.appendChild(progressBar);

  const timeText = document.createElement('a-text'); timeText.setAttribute('id','vr-time-text'); timeText.setAttribute('value','0:00 / 0:00'); timeText.setAttribute('align','center'); timeText.setAttribute('width','2'); timeText.setAttribute('position','0 -0.22 0.01'); timeText.setAttribute('color','#fff');
  seekBar.appendChild(timeText);

  panel.appendChild(seekBar);
  cameraRig.appendChild(panel);

  setInterval(updateVRSeekBar, 500);
  log('âœ“ VR panel oluÅŸturuldu');
}

function updateVRSeekBar(){
  if(!videoElement) return;
  const current = videoElement.currentTime || 0;
  const duration = videoElement.duration || 0;
  if(duration>0){
    const progress = current / duration;
    const progressBar = document.querySelector('#vr-progress-bar');
    const timeText = document.querySelector('#vr-time-text');
    if(progressBar){
      progressBar.setAttribute('width', VR_UI_CONFIG.seekBarWidth * progress);
      progressBar.setAttribute('position', `${-VR_UI_CONFIG.seekBarWidth/2 + (VR_UI_CONFIG.seekBarWidth*progress)/2} 0 0.01`);
    }
    if(timeText) timeText.setAttribute('value', `${formatTime(current)} / ${formatTime(duration)}`);
  }
}

/* ===========================
   Kontrol fonksiyonlarÄ± (play/pause/seek/stop)
   =========================== */
function canControlVideo(){
  if(!currentRoomData) return false;
  return currentRoomData.controlMode === 'everyone' || isRoomOwner;
}

function playVideo(){
  if(!canControlVideo()){
    sendControlRequest('play', { currentTime: videoElement ? videoElement.currentTime : 0 });
    alert('Play isteÄŸi gÃ¶nderildi (oda sahibine)');
    return;
  }
  if(!videoElement || !videoElement.paused) return;
  const startTimestamp = getAdjustedTime() + SYNC_DELAY;
  const currentTime = videoElement.currentTime;
  sendUrgentUpdate('play', { currentTime, startTimestamp });
  sendKeyframe();
  roomRef.child('videoState').update({ isPlaying:true, currentTime, startTimestamp, lastUpdate:getAdjustedTime() });
  showSyncStatus('â±ï¸ 10s sonra baÅŸlÄ±yor');
  log('â–¶ï¸ Play cmd (scheduled)');
}

function pauseVideo(){
  if(!canControlVideo()){
    sendControlRequest('pause', { currentTime: videoElement ? videoElement.currentTime : 0 });
    alert('Pause isteÄŸi gÃ¶nderildi (oda sahibine)');
    return;
  }
  if(!videoElement || videoElement.paused) return;
  videoElement.pause();
  sendUrgentUpdate('pause', { currentTime: videoElement.currentTime });
  sendKeyframe();
  roomRef.child('videoState').update({ isPlaying:false, currentTime: videoElement.currentTime, startTimestamp:null, lastUpdate:getAdjustedTime() });
  log('â¸ Pause cmd');
}

function stopVideo(){
  if(!canControlVideo()){
    sendControlRequest('stop', {});
    alert('Stop isteÄŸi gÃ¶nderildi (oda sahibine)');
    return;
  }
  if(!videoElement) return;
  videoElement.pause();
  try { videoElement.currentTime = 0; } catch(e){}
  roomRef.child('videoState').set({ isPlaying:false, currentTime:0, startTimestamp:null, lastUpdate:null });
  roomRef.child('urgentUpdates').remove();
  roomRef.child('keyframes').remove();
  showSyncStatus('â¹ï¸ BaÅŸa sarÄ±ldÄ±');
  log('â¹ Stop');
}

function seekVideo(seconds){
  if(!videoElement) return;
  if(!canControlVideo()){
    const target = Math.max(0, Math.min(videoElement.duration || 0, (videoElement.currentTime || 0) + seconds));
    sendControlRequest('seek', { currentTime: target, shouldPlay: !videoElement.paused });
    alert('Seek isteÄŸi gÃ¶nderildi (oda sahibine)');
    return;
  }
  const now = Date.now();
  if(now - lastSeekTime < SEEK_DEBOUNCE_DELAY) clearTimeout(seekDebounceTimeout);
  lastSeekTime = now;
  const target = Math.max(0, Math.min(videoElement.duration || 0, (videoElement.currentTime || 0) + seconds));
  videoElement.currentTime = target;
  showSyncStatus('â© ' + (seconds>0?'+':'') + seconds + 's (2s bekle...)');
  seekDebounceTimeout = setTimeout(()=>{
    const final = videoElement.currentTime;
    const rewind = Math.max(0, final - SEEK_REWIND_SECONDS);
    const wasPlaying = !videoElement.paused;
    videoElement.pause();
    videoElement.currentTime = rewind;
    const startTs = wasPlaying ? getAdjustedTime() + SYNC_DELAY : null;
    sendUrgentUpdate('seek', { currentTime: rewind, shouldPlay: wasPlaying, startTimestamp: startTs });
    sendKeyframe();
    roomRef.child('videoState').update({ isPlaying: wasPlaying, currentTime: rewind, startTimestamp: startTs, lastUpdate: getAdjustedTime() });
    if(wasPlaying) showSyncStatus('â±ï¸ 10s sonra devam ediyor');
    log('â© Seek completed to', rewind);
  }, SEEK_DEBOUNCE_DELAY);
}

function seekToPosition(percentage){
  if(!videoElement || !videoElement.duration) return;
  const target = videoElement.duration * percentage;
  if(!canControlVideo()){
    sendControlRequest('seek', { currentTime: target, shouldPlay: !videoElement.paused });
    alert('Seek isteÄŸi gÃ¶nderildi (oda sahibine)');
    return;
  }
  // same as seekVideo flow
  videoElement.currentTime = target;
  lastSeekTime = Date.now();
  clearTimeout(seekDebounceTimeout);
  seekDebounceTimeout = setTimeout(()=>{
    const final = videoElement.currentTime;
    const rewind = Math.max(0, final - SEEK_REWIND_SECONDS);
    const wasPlaying = !videoElement.paused;
    videoElement.pause(); videoElement.currentTime = rewind;
    const startTs = wasPlaying ? getAdjustedTime() + SYNC_DELAY : null;
    sendUrgentUpdate('seek', { currentTime: rewind, shouldPlay: wasPlaying, startTimestamp: startTs });
    sendKeyframe();
    roomRef.child('videoState').update({ isPlaying: wasPlaying, currentTime: rewind, startTimestamp: startTs, lastUpdate:getAdjustedTime() });
    if(wasPlaying) showSyncStatus('â±ï¸ 10s sonra devam ediyor');
    log('â© Seek bar ->', rewind);
  }, SEEK_DEBOUNCE_DELAY);
}

/* ===========================
   EkranÄ± hareket ettirme (VR)
   =========================== */
function moveScreen(dir){
  const screen = document.getElementById('video-screen');
  if(!screen) return;
  const step = 0.5;
  if(dir==='up') screenPosition.y += step;
  else if(dir==='down') screenPosition.y -= step;
  else if(dir==='left') screenPosition.x -= step;
  else if(dir==='right') screenPosition.x += step;
  else if(dir==='forward') screenPosition.z += step;
  else if(dir==='backward') screenPosition.z -= step;
  else if(dir==='reset') screenPosition = { x:0, y:2, z:-6 };
  screen.setAttribute('position', `${screenPosition.x} ${screenPosition.y} ${screenPosition.z}`);
  log('Ekran moved', screenPosition);
}

/* ===========================
   Keyboard shortcuts
   =========================== */
document.addEventListener('keydown', (e)=>{
  if(!currentRoomId || !videoElement) return;
  if(e.code === 'Space' && !['INPUT','TEXTAREA'].includes(e.target.tagName)){
    e.preventDefault(); videoElement.paused ? playVideo() : pauseVideo();
  }
  if(e.code === 'ArrowRight'){ e.preventDefault(); seekVideo(10); }
  if(e.code === 'ArrowLeft'){ e.preventDefault(); seekVideo(-10); }
  if(e.code === 'ArrowUp') moveScreen('up');
  if(e.code === 'ArrowDown') moveScreen('down');
  if(e.code === 'KeyW') moveScreen('up');
  if(e.code === 'KeyS') moveScreen('down');
  if(e.code === 'KeyA') moveScreen('left');
  if(e.code === 'KeyD') moveScreen('right');
  if(e.code === 'KeyR') moveScreen('reset');
  if(e.code === 'KeyM'){ e.preventDefault(); if(videoElement) videoElement.muted = !videoElement.muted; }
  if(e.code === 'KeyF'){
    e.preventDefault();
    const scene = document.querySelector('a-scene');
    if(document.fullscreenElement) document.exitFullscreen();
    else scene.requestFullscreen();
  }
});

/* ===========================
   Temizlik
   =========================== */
window.addEventListener('beforeunload', ()=>{
  if(keyframeIntervalId) clearInterval(keyframeIntervalId);
  if(syncTimeout) clearTimeout(syncTimeout);
  if(seekDebounceTimeout) clearTimeout(seekDebounceTimeout);
  if(roomRef) roomRef.off();
  if(videoElement){ try{ videoElement.pause(); videoElement.src=''; }catch(e){} }
});

/* ===========================
   YardÄ±mcÄ±: update room info UI
   =========================== */
function updateRoomInfoDisplay(){
  const rn = document.getElementById('room-name');
  const vc = document.getElementById('viewers-count');
  const cm = document.getElementById('control-mode');
  if(!currentRoomData) return;
  if(rn) rn.textContent = currentRoomData.name;
  if(vc) {
    roomRef.child('viewers').on('value', s => { vc.textContent = s.val() || 0; });
  }
  if(cm) cm.textContent = currentRoomData.controlMode === 'owner' ? 'Sadece Sahip' : 'Herkes';
}

/* ===========================
   BaÅŸlangÄ±Ã§: odalarÄ± listele
   =========================== */
window.addEventListener('load', ()=> {
  listRooms();
  log('âœ“ Uygulama yÃ¼klendi');
});
</script>
</body>
</html>