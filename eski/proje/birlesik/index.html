<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Sinema - Ultra Sync</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        /* VR Sƒ∞NEMA ULTRA - STYLES */
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s;
        }
        
        #ui-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .ui-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            color: #667eea;
            margin-top: 0;
            font-size: 2em;
            text-align: center;
        }
        
        h2 {
            color: #444;
            font-size: 1.3em;
            margin-top: 30px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border 0.3s;
            font-family: inherit;
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 5px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        button.stop {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
        }
        
        .room-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .room-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .room-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }
        
        .room-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        #vr-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 15px;
            display: none;
        }
        
        #vr-controls.visible {
            display: block;
        }
        
        #vr-controls button {
            margin: 0 5px;
            font-size: 14px;
            padding: 10px 20px;
        }
        
        #room-info-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 100;
            display: none;
            font-size: 0.9em;
        }
        
        #room-info-display.visible {
            display: block;
        }
        
        #room-info-display div {
            margin: 5px 0;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            margin: 15px 0;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        
        .radio-container {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .radio-container label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
        }
        
        .radio-container input[type="radio"] {
            width: auto;
            margin-right: 8px;
        }
        
        #sync-status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 1.2em;
            z-index: 999;
            display: none;
        }
        
        .ui-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .ui-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        
        .ui-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        .ui-container::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        @media (max-width: 768px) {
            .ui-container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            #vr-controls {
                bottom: 10px;
                padding: 10px 15px;
            }
            
            #vr-controls button {
                font-size: 12px;
                padding: 8px 15px;
            }
            
            #room-info-display {
                top: 10px;
                right: 10px;
                font-size: 0.8em;
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <!-- UI OVERLAY -->
    <div id="ui-overlay">
        <div class="ui-container">
            <h1>üé¨ VR Sinema Ultra</h1>
            
            <h2>Yeni Oda Olu≈ütur</h2>
            <input type="text" id="room-name-input" placeholder="Oda Adƒ±" />
            <input type="text" id="video-url-input" placeholder="Video URL (YouTube, Google Drive, Direkt Link)" />
            <input type="text" id="subtitle-url-input" placeholder="Altyazƒ± URL (.srt) - Opsiyonel" />
            
            <label>Ortam:</label>
            <select id="environment-select">
                <option value="none">Ortamsƒ±z</option>
                <option value="default" selected>Klasik</option>
                <option value="forest">Orman</option>
                <option value="starry">Yƒ±ldƒ±zlƒ± Gece</option>
            </select>
            
            <label>Ekran T√ºr√º:</label>
            <select id="screen-size">
                <option value="flat" selected>D√ºz Ekran</option>
                <option value="360">360¬∞ Video</option>
                <option value="180">180¬∞ Video</option>
            </select>
            
            <div class="checkbox-container">
                <input type="checkbox" id="private-room" />
                <label for="private-room">√ñzel Oda (≈ûifreli)</label>
            </div>
            <input type="password" id="room-password" placeholder="Oda ≈ûifresi (√∂zel oda i√ßin)" />
            
            <div class="radio-container">
                <label><strong>Kontrol Modu:</strong></label>
                <label>
                    <input type="radio" name="control-mode" value="owner" checked />
                    Sadece Oda Sahibi Kontrol Eder
                </label>
                <label>
                    <input type="radio" name="control-mode" value="everyone" />
                    Herkes Kontrol Edebilir
                </label>
            </div>
            
            <button onclick="createRoom()">üöÄ Oda Olu≈ütur ve Ba≈ülat</button>
            
            <h2>A√ßƒ±k Odalar</h2>
            <button class="secondary" onclick="listRooms()">üîÑ Odalarƒ± Yenile</button>
            <div id="rooms-list">Y√ºkleniyor...</div>
        </div>
    </div>

    <!-- SYNC STATUS -->
    <div id="sync-status"></div>

    <!-- ROOM INFO -->
    <div id="room-info-display">
        <div><strong id="room-name">-</strong></div>
        <div>üë• <span id="viewers-count">0</span> ki≈üi</div>
        <div>üéÆ <span id="control-mode">-</span></div>
    </div>

    <!-- VR CONTROLS (2D) -->
    <div id="vr-controls">
        <button onclick="playVideo()">‚ñ∂Ô∏è Oynat</button>
        <button onclick="pauseVideo()">‚è∏Ô∏è Duraklat</button>
        <button onclick="seekVideo(-10)">‚è™ -10sn</button>
        <button onclick="seekVideo(10)">‚è© +10sn</button>
        <button class="stop" onclick="stopVideo()">‚èπÔ∏è Durdur</button>
    </div>

    <!-- VR SCENE -->
    <a-scene>
        <a-entity id="camera-rig">
            <a-camera>
                <a-cursor color="#0f0" fuse="true" fuse-timeout="1500"></a-cursor>
            </a-camera>
        </a-entity>
        
        <a-entity id="video-screen" position="0 2 -10" visible="false"></a-entity>
        <a-entity environment="preset: default; lighting: distant;"></a-entity>
    </a-scene>

    <script>
    // ============================================
    // CONFIG - ULTRA VERSƒ∞YON
    // 10sn Senkron | 7sn Keyframe
    // ============================================
    const firebaseConfig = {
        apiKey: "AIzaSyC60idSLdAiqAjPWAOMaM3g8LAKPGEUwH8",
        authDomain: "vr-sinema.firebaseapp.com",
        databaseURL: "https://vr-sinema-default-rtdb.firebaseio.com",
        projectId: "vr-sinema",
        storageBucket: "vr-sinema.firebasestorage.app",
        messagingSenderId: "724648238300",
        appId: "1:724648238300:web:dceba8c536e8a5ffd96819"
    };
    firebase.initializeApp(firebaseConfig);

    const SYNC_DELAY = 10000; // 10 SANƒ∞YE
    const KEYFRAME_INTERVAL = 7000; // 7 SANƒ∞YE
    const CLOCK_SYNC_INTERVAL = 60000;
    const SEEK_DEBOUNCE_DELAY = 2000;
    const SEEK_REWIND_SECONDS = 4;
    const SMOOTH_THRESHOLD = 5000;

    const ENVIRONMENTS = {
        'none': { name: 'Ortamsƒ±z', preset: null },
        'default': { name: 'Klasik', preset: 'default' },
        'forest': { name: 'Orman', preset: 'forest' },
        'starry': { name: 'Yƒ±ldƒ±z', preset: 'starry' }
    };

    const VIDEO_SERVICES = {
        youtube: {
            pattern: /(youtu\.be\/|youtube\.com\/(watch\?v=|embed\/|v\/|shorts\/))([\w-]{11})/,
            transform: (m) => `https://www.youtube.com/embed/${m[3]}?autoplay=1&controls=1`
        },
        googledrive: {
            pattern: /drive\.google\.com\/(?:file\/d\/|open\?id=)([a-zA-Z0-9_-]+)/,
            transform: (m) => `https://mefeypublicv2.recepyeni.workers.dev/?url=${encodeURIComponent('https://drive.google.com/uc?export=download&id=' + m[1])}`
        },
        direct: {
            pattern: /\.(mp4|webm|ogg|mov|mkv|m3u8|ts)(\?|$)/i,
            transform: (url) => url
        }
    };

    const VR_UI_CONFIG = {
        position: { x: -5, y: 1.6, z: -3 },
        rotation: { x: 0, y: 90, z: 0 },
        scale: 0.7,
        buttonSize: 0.28,
        seekBarWidth: 1.8
    };

    let database = firebase.database();
    let auth = firebase.auth();
    let roomsRef = database.ref('rooms');
    let roomRef = null;
    let videoElement = null;
    let currentRoomId = null;
    let currentRoomData = null;
    let isRoomOwner = false;
    let currentEnvironment = 'default';
    let clockOffset = 0;
    let clockSyncReady = false;
    let keyframeInterval = null;
    let lastKeyframeTimestamp = 0;
    let syncTimeout = null;
    let lastSeekTime = 0;
    let seekDebounceTimeout = null;
    let subtitleElement = null;
    let subtitleData = null;
    let screenPosition = { x: 0, y: 2, z: -10 };

    console.log('‚úì Config y√ºklendi: 10sn Senkron | 7sn Keyframe');

    // ============================================
    // CORE - Hƒ∞BRƒ∞T SENKRONƒ∞ZASYON Sƒ∞STEMƒ∞
    // ============================================
    
    function syncClock() {
        if (!roomRef) return;
        const t1 = Date.now();
        roomRef.child('serverTimestamp').set(firebase.database.ServerValue.TIMESTAMP);
        roomRef.child('serverTimestamp').once('value', (snap) => {
            const t4 = Date.now();
            const t2 = snap.val();
            const roundTrip = t4 - t1;
            const newOffset = (t2 + roundTrip / 2) - t4;
            clockOffset = clockOffset === 0 ? newOffset : (clockOffset * 0.7) + (newOffset * 0.3);
            clockSyncReady = true;
            console.log('‚è∞ Clock:', Math.round(clockOffset), 'ms');
        });
    }

    function getAdjustedTime() {
        return clockSyncReady ? Date.now() + clockOffset : Date.now();
    }

    function sendKeyframe() {
        if (!isRoomOwner || !videoElement || !roomRef) return;
        const kf = {
            timestamp: getAdjustedTime(),
            currentTime: videoElement.currentTime,
            isPlaying: !videoElement.paused,
            playbackRate: videoElement.playbackRate || 1,
            startTimestamp: !videoElement.paused ? getAdjustedTime() : null
        };
        roomRef.child('keyframes').child(Math.floor(kf.timestamp).toString()).set(kf);
        console.log('üì∏ Keyframe:', kf.currentTime.toFixed(1), 's');
    }

    function startKeyframeInterval() {
        if (keyframeInterval) clearInterval(keyframeInterval);
        if (isRoomOwner) {
            keyframeInterval = setInterval(sendKeyframe, KEYFRAME_INTERVAL);
            console.log('‚úì Keyframe ba≈ülatƒ±ldƒ±: 7sn');
            setInterval(() => {
                const fiveMinutesAgo = Date.now() - 300000;
                roomRef.child('keyframes')
                    .orderByChild('timestamp')
                    .endAt(fiveMinutesAgo)
                    .once('value', snap => {
                        snap.forEach(child => child.ref.remove());
                    });
            }, 60000);
        }
    }

    function listenToKeyframes() {
        if (!roomRef) return;
        roomRef.child('keyframes').on('child_added', (snapshot) => {
            const kf = snapshot.val();
            if (!kf || !videoElement || kf.timestamp <= lastKeyframeTimestamp) return;
            const now = getAdjustedTime();
            if (kf.isPlaying && kf.startTimestamp) {
                const elapsed = (now - kf.startTimestamp) / 1000;
                const predicted = kf.currentTime + elapsed;
                const drift = Math.abs(videoElement.currentTime - predicted);
                if (drift < SMOOTH_THRESHOLD / 1000) {
                    console.log('‚úÖ Smooth:', drift.toFixed(2), 's');
                    lastKeyframeTimestamp = kf.timestamp;
                    return;
                }
                videoElement.currentTime = predicted;
                console.log('üîÑ Predictive:', predicted.toFixed(1), 's');
            }
            if (kf.isPlaying && videoElement.paused) {
                videoElement.play().catch(e => console.log('‚ö†Ô∏è Auto-play:', e));
            } else if (!kf.isPlaying && !videoElement.paused) {
                videoElement.pause();
            }
            lastKeyframeTimestamp = kf.timestamp;
        });
        console.log('‚úì Keyframe listener aktif');
    }

    function sendUrgentUpdate(action, params) {
        if (!roomRef) return;
        const ref = roomRef.child('urgentUpdates').push();
        ref.set({
            action: action,
            timestamp: getAdjustedTime(),
            ...params,
            processed: false
        });
        console.log('‚ö° Urgent:', action);
    }

    function listenToUrgentUpdates() {
        if (!roomRef) return;
        roomRef.child('urgentUpdates').on('child_added', (snapshot) => {
            const upd = snapshot.val();
            if (!upd || !videoElement || upd.processed) return;
            snapshot.ref.update({ processed: true });
            handleUrgentUpdate(upd);
            setTimeout(() => snapshot.ref.remove(), 10000);
        });
        console.log('‚úì Urgent listener aktif');
    }

    function handleUrgentUpdate(upd) {
        const now = getAdjustedTime();
        if (upd.action === 'play' && upd.startTimestamp) {
            const wait = upd.startTimestamp - now;
            videoElement.currentTime = upd.currentTime;
            if (wait > 0) {
                videoElement.pause();
                if (syncTimeout) clearTimeout(syncTimeout);
                syncTimeout = setTimeout(() => {
                    videoElement.play().catch(e => console.log('‚ö†Ô∏è Auto-play:', e));
                }, wait);
                console.log('‚è±Ô∏è', (wait / 1000).toFixed(1), 'sn sonra ba≈ülƒ±yor');
                showSyncStatus('‚è±Ô∏è ' + (wait / 1000).toFixed(1) + 'sn sonra ba≈ülƒ±yor');
            } else {
                videoElement.play().catch(e => console.log('‚ö†Ô∏è Auto-play:', e));
            }
        } else if (upd.action === 'pause') {
            videoElement.pause();
            if (upd.currentTime !== undefined) videoElement.currentTime = upd.currentTime;
            console.log('‚è∏Ô∏è Durduruldu (urgent)');
        } else if (upd.action === 'seek') {
            videoElement.currentTime = upd.currentTime;
            if (upd.shouldPlay && upd.startTimestamp) {
                const wait = upd.startTimestamp - now;
                if (wait > 0) {
                    videoElement.pause();
                    if (syncTimeout) clearTimeout(syncTimeout);
                    syncTimeout = setTimeout(() => {
                        videoElement.play().catch(e => console.log('‚ö†Ô∏è Auto-play:', e));
                    }, wait);
                    console.log('‚è±Ô∏è Seek sonrasƒ±', (wait / 1000).toFixed(1), 'sn sonra ba≈ülƒ±yor');
                    showSyncStatus('‚è±Ô∏è ' + (wait / 1000).toFixed(1) + 'sn sonra ba≈ülƒ±yor');
                } else {
                    videoElement.play().catch(e => console.log('‚ö†Ô∏è Auto-play:', e));
                }
            }
            console.log('‚è© Seek (urgent):', upd.currentTime.toFixed(1), 's');
        }
    }

    function sendControlRequest(action, params = {}) {
        if (!roomRef || !auth.currentUser) return;
        roomRef.child('requests').push().set({
            userId: auth.currentUser.uid,
            action: action,
            params: params,
            timestamp: Date.now(),
            processed: false
        });
        console.log('üì® ƒ∞stek:', action);
    }

    function listenToControlRequests() {
        if (!isRoomOwner || !roomRef) return;
        console.log('üëë ƒ∞stek dinleniyor...');
        roomRef.child('requests').on('child_added', (snapshot) => {
            const req = snapshot.val();
            if (req.processed) return;
            console.log('üì¨ ƒ∞stek alƒ±ndƒ±:', req.action);
            processControlRequest(req);
            snapshot.ref.update({ processed: true });
            setTimeout(() => snapshot.ref.remove(), 10000);
        });
    }

    function processControlRequest(req) {
        if (!videoElement) return;
        if (req.action === 'play') playVideo();
        else if (req.action === 'pause') pauseVideo();
        else if (req.action === 'seek' && req.params.currentTime !== undefined) {
            videoElement.currentTime = req.params.currentTime;
            if (req.params.shouldPlay) playVideo();
        }
    }

    function performInitialSync() {
        if (!roomRef || !videoElement) return;
        roomRef.child('keyframes').limitToLast(1).once('value', (snapshot) => {
            if (!snapshot.exists()) return;
            const kf = Object.values(snapshot.val())[0];
            console.log('üì¶ Progressive loading...');
            videoElement.addEventListener('loadedmetadata', () => {
                console.log('‚úì Metadata');
                const now = getAdjustedTime();
                if (kf.isPlaying && kf.startTimestamp) {
                    const elapsed = (now - kf.startTimestamp) / 1000;
                    const predicted = kf.currentTime + elapsed;
                    videoElement.currentTime = predicted;
                    videoElement.addEventListener('canplay', () => {
                        console.log('‚úì Buffer hazƒ±r');
                        videoElement.play().catch(e => console.log('‚ö†Ô∏è Auto-play:', e));
                        videoElement.preload = 'auto';
                    }, { once: true });
                } else {
                    videoElement.currentTime = kf.currentTime;
                    videoElement.preload = 'auto';
                }
            }, { once: true });
        });
    }

    function canControlVideo() {
        if (!currentRoomData) return false;
        return currentRoomData.controlMode === 'everyone' || isRoomOwner;
    }

    function playVideo() {
        if (!canControlVideo()) {
            sendControlRequest('play', { currentTime: videoElement.currentTime });
            alert('üì¢ Play isteƒüi g√∂nderildi!');
            return;
        }
        if (!videoElement || !videoElement.paused) return;
        const startTimestamp = getAdjustedTime() + SYNC_DELAY;
        const currentTime = videoElement.currentTime;
        sendUrgentUpdate('play', {
            currentTime: currentTime,
            startTimestamp: startTimestamp
        });
        sendKeyframe();
        roomRef.child('videoState').update({
            isPlaying: true,
            currentTime: currentTime,
            startTimestamp: startTimestamp,
            lastUpdate: getAdjustedTime()
        });
        console.log('‚ñ∂Ô∏è Play:', currentTime.toFixed(1), 's ‚Üí 10sn sonra');
        showSyncStatus('‚è±Ô∏è 10sn sonra ba≈ülƒ±yor');
    }

    function pauseVideo() {
        if (!canControlVideo()) {
            sendControlRequest('pause', { currentTime: videoElement.currentTime });
            alert('üì¢ Pause isteƒüi g√∂nderildi!');
            return;
        }
        if (!videoElement || videoElement.paused) return;
        videoElement.pause();
        sendUrgentUpdate('pause', { currentTime: videoElement.currentTime });
        sendKeyframe();
        roomRef.child('videoState').update({
            isPlaying: false,
            currentTime: videoElement.currentTime,
            startTimestamp: null,
            lastUpdate: getAdjustedTime()
        });
        console.log('‚è∏Ô∏è Durduruldu');
    }

    function stopVideo() {
        if (!canControlVideo()) {
            sendControlRequest('stop', {});
            alert('üì¢ Stop isteƒüi g√∂nderildi!');
            return;
        }
        if (!videoElement) return;
        videoElement.pause();
        videoElement.currentTime = 0;
        roomRef.child('videoState').set({
            isPlaying: false,
            currentTime: 0,
            startTimestamp: null,
            lastUpdate: null
        });
        roomRef.child('urgentUpdates').remove();
        roomRef.child('keyframes').remove();
        console.log('‚èπ Ba≈üa sarƒ±ldƒ±');
        showSyncStatus('‚èπ Ba≈üa sarƒ±ldƒ±');
    }

    function seekVideo(seconds) {
        if (!canControlVideo()) {
            const target = Math.max(0, Math.min(videoElement.duration, videoElement.currentTime + seconds));
            sendControlRequest('seek', {
                currentTime: target,
                shouldPlay: !videoElement.paused
            });
            alert('üì¢ Seek isteƒüi g√∂nderildi!');
            return;
        }
        if (!videoElement) return;
        const now = Date.now();
        if (now - lastSeekTime < SEEK_DEBOUNCE_DELAY) clearTimeout(seekDebounceTimeout);
        lastSeekTime = now;
        const target = Math.max(0, Math.min(videoElement.duration, videoElement.currentTime + seconds));
        videoElement.currentTime = target;
        showSyncStatus('‚è© ' + (seconds > 0 ? '+' : '') + seconds + 'sn (2sn bekle...)');
        seekDebounceTimeout = setTimeout(() => {
            const final = videoElement.currentTime;
            const rewind = Math.max(0, final - SEEK_REWIND_SECONDS);
            const wasPlaying = !videoElement.paused;
            videoElement.pause();
            videoElement.currentTime = rewind;
            const startTs = wasPlaying ? getAdjustedTime() + SYNC_DELAY : null;
            sendUrgentUpdate('seek', {
                currentTime: rewind,
                shouldPlay: wasPlaying,
                startTimestamp: startTs
            });
            sendKeyframe();
            roomRef.child('videoState').update({
                isPlaying: wasPlaying,
                currentTime: rewind,
                startTimestamp: startTs,
                lastUpdate: getAdjustedTime()
            });
            if (wasPlaying) {
                showSyncStatus('‚è±Ô∏è 10sn sonra devam ediyor');
                console.log('‚è© Seek tamamlandƒ±, 10sn sonra devam');
            } else {
                console.log('‚è© Seek tamamlandƒ±, duraklatƒ±ldƒ±');
            }
        }, SEEK_DEBOUNCE_DELAY);
    }

    function seekToPosition(percentage) {
        if (!canControlVideo()) {
            const target = videoElement.duration * percentage;
            sendControlRequest('seek', {
                currentTime: target,
                shouldPlay: !videoElement.paused
            });
            alert('üì¢ Seek isteƒüi g√∂nderildi!');
            return;
        }
        if (!videoElement || !videoElement.duration) return;
        const target = videoElement.duration * percentage;
        videoElement.currentTime = target;
        const now = Date.now();
        if (now - lastSeekTime < SEEK_DEBOUNCE_DELAY) clearTimeout(seekDebounceTimeout);
        lastSeekTime = now;
        seekDebounceTimeout = setTimeout(() => {
            const final = videoElement.currentTime;
            const rewind = Math.max(0, final - SEEK_REWIND_SECONDS);
            const wasPlaying = !videoElement.paused;
            videoElement.pause();
            videoElement.currentTime = rewind;
            const startTs = wasPlaying ? getAdjustedTime() + SYNC_DELAY : null;
            sendUrgentUpdate('seek', {
                currentTime: rewind,
                shouldPlay: wasPlaying,
                startTimestamp: startTs
            });
            sendKeyframe();
            roomRef.child('videoState').update({
                isPlaying: wasPlaying,
                currentTime: rewind,
                startTimestamp: startTs,
                lastUpdate: getAdjustedTime()
            });
            if (wasPlaying) {
                showSyncStatus('‚è±Ô∏è 10sn sonra devam ediyor');
                console.log('‚è© Seek bar tamamlandƒ±, 10sn sonra devam');
            } else {
                console.log('‚è© Seek bar tamamlandƒ±, duraklatƒ±ldƒ±');
            }
        }, SEEK_DEBOUNCE_DELAY);
    }

    function initHybridSync() {
        if (!roomRef || !videoElement) return;
        console.log('üöÄ Hibrit sistem ba≈ülatƒ±lƒ±yor...');
        syncClock();
        setInterval(syncClock, CLOCK_SYNC_INTERVAL);
        listenToKeyframes();
        listenToUrgentUpdates();
        if (isRoomOwner) {
            startKeyframeInterval();
            listenToControlRequests();
            setInterval(() => {
                const oneMinuteAgo = Date.now() - 60000;
                roomRef.child('urgentUpdates')
                    .orderByChild('timestamp')
                    .endAt(oneMinuteAgo)
                    .once('value', snap => {
                        snap.forEach(child => child.ref.remove());
                    });
                roomRef.child('requests')
                    .orderByChild('timestamp')
                    .endAt(oneMinuteAgo)
                    .once('value', snap => {
                        snap.forEach(child => child.ref.remove());
                    });
            }, 30000);
        }
        performInitialSync();
        console.log('‚úì Hibrit sistem aktif');
    }

    // ============================================
    // UI & ODA Y√ñNETƒ∞Mƒ∞
    // ============================================
    
    function throttle(func, delay) {
        let lastCall = 0;
        return function(...args) {
            const now = Date.now();
            if (now - lastCall >= delay) {
                lastCall = now;
                func(...args);
            }
        };
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showSyncStatus(msg) {
        const el = document.getElementById('sync-status');
        if (el) {
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }
    }

    const updateRoomInfoDisplay = throttle(function() {
        if (!currentRoomData) return;
        const rn = document.getElementById('room-name');
        const vc = document.getElementById('viewers-count');
        const cm = document.getElementById('control-mode');
        if (rn) rn.textContent = currentRoomData.name;
        if (vc) vc.textContent = currentRoomData.viewers || 0;
        if (cm) cm.textContent = currentRoomData.controlMode === 'owner' ? 'Sadece Sahip' : 'Herkes';
    }, 3000);

    function detectVideoService(url) {
        if (!url) return 'unknown';
        for (const [service, config] of Object.entries(VIDEO_SERVICES)) {
            if (config.pattern.test(url)) return service;
        }
        return 'direct';
    }

    function getVideoUrl(inputUrl) {
        if (!inputUrl) return null;
        const service = detectVideoService(inputUrl);
        if (service === 'direct') return inputUrl;
        if (VIDEO_SERVICES[service]) {
            const config = VIDEO_SERVICES[service];
            const match = inputUrl.match(config.pattern);
            if (match) return config.transform(match.input || inputUrl);
        }
        return inputUrl;
    }

    function createRoom() {
        const roomName = document.getElementById('room-name-input').value.trim();
        const videoUrl = document.getElementById('video-url-input').value.trim();
        const subtitleUrl = document.getElementById('subtitle-url-input').value.trim();
        const environment = document.getElementById('environment-select').value;
        const screenSize = document.getElementById('screen-size').value;
        const isPrivate = document.getElementById('private-room').checked;
        const roomPassword = document.getElementById('room-password').value.trim();
        const controlMode = document.querySelector('input[name="control-mode"]:checked').value;
        
        if (!roomName || !videoUrl) {
            alert('‚ö†Ô∏è Oda adƒ± ve video URL gerekli!');
            return;
        }
        
        auth.signInAnonymously().then(() => {
            const userId = auth.currentUser.uid;
            const newRoomRef = roomsRef.push();
            const roomData = {
                name: roomName,
                videoUrl: videoUrl,
                subtitleUrl: subtitleUrl || null,
                environment: environment,
                screenSize: screenSize,
                owner: userId,
                isPrivate: isPrivate,
                password: isPrivate ? roomPassword : null,
                controlMode: controlMode,
                viewers: 1,
                createdAt: Date.now(),
                videoState: {
                    isPlaying: false,
                    currentTime: 0,
                    startTimestamp: null,
                    lastUpdate: Date.now()
                }
            };
            newRoomRef.set(roomData).then(() => {
                joinRoom(newRoomRef.key, roomPassword);
            });
        });
    }

    function joinRoom(roomId, password = null) {
        roomsRef.child(roomId).once('value').then((snapshot) => {
            const room = snapshot.val();
            if (!room) {
                alert('‚ö†Ô∏è Oda bulunamadƒ±!');
                return;
            }
            if (room.isPrivate && room.password !== password) {
                const pw = prompt('üîí ≈ûifre:');
                if (pw !== room.password) {
                    alert('‚ùå Yanlƒ±≈ü ≈üifre!');
                    return;
                }
            }
            auth.signInAnonymously().then(() => {
                const userId = auth.currentUser.uid;
                currentRoomId = roomId;
                currentRoomData = room;
                roomRef = roomsRef.child(roomId);
                isRoomOwner = (room.owner === userId);
                if (room.password) roomRef.child('password').remove();
                roomRef.child('viewers').transaction((c) => (c || 0) + 1);
                const presenceRef = database.ref('.info/connected');
                presenceRef.on('value', (snap) => {
                    if (snap.val()) {
                        const myPresence = roomRef.child('activeViewers').child(userId);
                        myPresence.onDisconnect().remove();
                        myPresence.set({
                            timestamp: Date.now(),
                            isOwner: isRoomOwner
                        });
                        roomRef.child('viewers').onDisconnect().set(firebase.database.ServerValue.increment(-1));
                        if (isRoomOwner) roomRef.child('owner').onDisconnect().remove();
                    }
                });
                currentEnvironment = room.environment;
                setupVideo(room.videoUrl, room.screenSize);
                if (room.subtitleUrl) loadSubtitle(room.subtitleUrl);
                createVRUIPanel();
                document.getElementById('ui-overlay').classList.add('hidden');
                document.getElementById('vr-controls').classList.add('visible');
                document.getElementById('room-info-display').classList.add('visible');
                updateRoomInfoDisplay();
                if (typeof initHybridSync === 'function') initHybridSync();
                console.log('‚úì Odaya katƒ±ldƒ±:', roomId, '| Sahip:', isRoomOwner);
            });
        });
    }

    function listRooms() {
        roomsRef.once('value').then((snapshot) => {
            const rooms = snapshot.val();
            const list = document.getElementById('rooms-list');
            list.innerHTML = '';
            if (!rooms) {
                list.innerHTML = '<p class="loading">A√ßƒ±k oda yok</p>';
                return;
            }
            let count = 0;
            Object.entries(rooms).forEach(([rid, room]) => {
                if (room.isPrivate) return;
                count++;
                const div = document.createElement('div');
                div.className = 'room-item';
                div.onclick = () => joinRoom(rid);
                div.innerHTML = `
                    <div class="room-name">${escapeHtml(room.name)}</div>
                    <div class="room-info">
                        üë• ${room.viewers || 0} ki≈üi | 
                        üéÆ ${room.controlMode === 'owner' ? 'Owner' : 'Herkes'} | 
                        üåç ${ENVIRONMENTS[room.environment]?.name || 'Bilinmiyor'}
                    </div>
                `;
                list.appendChild(div);
            });
            if (count === 0) {
                list.innerHTML = '<p class="loading">A√ßƒ±k oda yok</p>';
            }
        });
    }

    function setupVideo(videoUrl, screenSize) {
        const url = getVideoUrl(videoUrl);
        if (!url) {
            alert('‚ùå Video URL hatasƒ±!');
            return;
        }
        setupVideoTexture(url, screenSize);
        const scene = document.querySelector('a-scene');
        const env = scene.querySelector('[environment]');
        if (env) {
            env.setAttribute('environment', {
                preset: currentEnvironment,
                lighting: 'distant'
            });
        }
    }

    function setupVideoTexture(videoUrl, screenSize) {
        const scene = document.querySelector('a-scene');
        const screen = document.getElementById('video-screen');
        const sizes = {
            'flat': { width: 16, height: 9 },
            '360': { width: 100, height: 100 },
            '180': { width: 50, height: 50 }
        };
        const size = sizes[screenSize] || sizes['flat'];
        
        if (screenSize === '360') {
            screen.setAttribute('geometry', 'primitive: sphere; radius: 50');
            screen.setAttribute('material', 'side: back');
            screen.setAttribute('scale', '-1 1 1');
        } else if (screenSize === '180') {
            screen.setAttribute('geometry', 'primitive: sphere; radius: 25; thetaLength: 180');
            screen.setAttribute('material', 'side: back');
            screen.setAttribute('scale', '-1 1 1');
        } else {
            screen.setAttribute('geometry', `primitive: plane; width: ${size.width}; height: ${size.height}`);
            screen.removeAttribute('scale');
        }
        
        let assets = document.querySelector('a-assets');
        if (!assets) {
            assets = document.createElement('a-assets');
            scene.appendChild(assets);
        }
        
        const oldVideo = document.getElementById('video-src');
        if (oldVideo) {
            oldVideo.pause();
            oldVideo.src = '';
            oldVideo.remove();
        }
        
        const video = document.createElement('video');
        video.id = 'video-src';
        video.crossOrigin = 'anonymous';
        video.preload = 'metadata';
        video.loop = false;
        video.playsInline = true;
        video.muted = false;
        assets.appendChild(video);
        videoElement = video;
        
        videoElement.addEventListener('loadedmetadata', () => {
            console.log('‚úì Metadata:', videoElement.duration.toFixed(1), 's');
        });
        
        videoElement.addEventListener('canplay', () => {
            console.log('‚úì Oynatmaya hazƒ±r');
            screen.setAttribute('visible', 'true');
        });
        
        videoElement.addEventListener('error', (e) => {
            console.error('‚ùå Video hatasƒ±:', e);
            alert('‚ùå Video y√ºklenemedi!');
        });
        
        videoElement.src = videoUrl;
        videoElement.load();
        screen.setAttribute('src', '#video-src');
    }

    function loadSubtitle(url) {
        if (!url) return;
        fetch(url).then(r => r.text()).then(text => {
            subtitleData = parseSRT(text);
            console.log('‚úì Altyazƒ±:', subtitleData.length, 'satƒ±r');
            startSubtitleUpdate();
        }).catch(err => {
            console.error('‚ùå Altyazƒ± hatasƒ±:', err);
        });
    }

    function parseSRT(srt) {
        const subs = [];
        const blocks = srt.trim().split(/\n\s*\n/);
        blocks.forEach(block => {
            const lines = block.split('\n');
            if (lines.length >= 3) {
                const time = lines[1];
                const match = time.match(/(\d{2}):(\d{2}):(\d{2}),(\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2}),(\d{3})/);
                if (match) {
                    const start = parseFloat(match[1]) * 3600 + parseFloat(match[2]) * 60 + parseFloat(match[3]) + parseFloat(match[4]) / 1000;
                    const end = parseFloat(match[5]) * 3600 + parseFloat(match[6]) * 60 + parseFloat(match[7]) + parseFloat(match[8]) / 1000;
                    subs.push({ start, end, text: lines.slice(2).join('\n') });
                }
            }
        });
        return subs;
    }

    function startSubtitleUpdate() {
        if (!subtitleElement) {
            const scene = document.querySelector('a-scene');
            subtitleElement = document.createElement('a-text');
            subtitleElement.setAttribute('id', 'subtitle');
            subtitleElement.setAttribute('value', '');
            subtitleElement.setAttribute('align', 'center');
            subtitleElement.setAttribute('width', 20);
            subtitleElement.setAttribute('position', '0 -3 -10');
            subtitleElement.setAttribute('color', '#FFF');
            subtitleElement.setAttribute('visible', 'false');
            scene.appendChild(subtitleElement);
        }
        setInterval(() => {
            if (!videoElement || !subtitleData) return;
            const t = videoElement.currentTime;
            const sub = subtitleData.find(s => t >= s.start && t <= s.end);
            if (sub) {
                subtitleElement.setAttribute('value', sub.text);
                subtitleElement.setAttribute('visible', 'true');
            } else {
                subtitleElement.setAttribute('visible', 'false');
            }
        }, 100);
    }

    // ============================================
    // VR KONTROL PANELƒ∞
    // ============================================
    
    function createVRUIPanel() {
        const scene = document.querySelector('a-scene');
        const cameraRig = document.querySelector('#camera-rig');
        
        const panel = document.createElement('a-entity');
        panel.setAttribute('id', 'vr-ui-panel');
        panel.setAttribute('position', `${VR_UI_CONFIG.position.x} ${VR_UI_CONFIG.position.y} ${VR_UI_CONFIG.position.z}`);
        panel.setAttribute('rotation', `${VR_UI_CONFIG.rotation.x} ${VR_UI_CONFIG.rotation.y} ${VR_UI_CONFIG.rotation.z}`);
        
        const bg = document.createElement('a-plane');
        bg.setAttribute('width', '2.5');
        bg.setAttribute('height', '3');
        bg.setAttribute('color', '#222');
        bg.setAttribute('opacity', '0.9');
        panel.appendChild(bg);
        
        const title = document.createElement('a-text');
        title.setAttribute('value', 'KONTROL');
        title.setAttribute('align', 'center');
        title.setAttribute('width', '2');
        title.setAttribute('position', '0 1.3 0.01');
        title.setAttribute('color', '#0f0');
        panel.appendChild(title);
        
        const screenBtns = [
            { x: 0, y: 0.8, label: '‚Üë', action: () => moveScreen('up') },
            { x: 0, y: 0.2, label: '‚Üì', action: () => moveScreen('down') },
            { x: -0.4, y: 0.5, label: '‚Üê', action: () => moveScreen('left') },
            { x: 0.4, y: 0.5, label: '‚Üí', action: () => moveScreen('right') },
            { x: -0.8, y: 0.5, label: '+', action: () => moveScreen('forward') },
            { x: 0.8, y: 0.5, label: '-', action: () => moveScreen('backward') },
            { x: 0, y: -0.2, label: '‚ü≤', action: () => moveScreen('reset'), size: 0.4 }
        ];
        
        screenBtns.forEach(btn => {
            const b = createVRButton(btn.x, btn.y, 0.02, btn.label, btn.size || VR_UI_CONFIG.buttonSize, btn.action);
            panel.appendChild(b);
        });
        
        const videoBtns = [
            { x: -0.6, y: -0.8, label: '‚Æú', action: () => seekVideo(-10) },
            { x: -0.3, y: -0.8, label: '‚ñ∂', action: () => videoElement && videoElement.paused ? playVideo() : pauseVideo() },
            { x: 0, y: -0.8, label: '‚ñ†', action: () => stopVideo() },
            { x: 0.3, y: -0.8, label: '‚Æû', action: () => seekVideo(10) }
        ];
        
        videoBtns.forEach(btn => {
            const b = createVRButton(btn.x, btn.y, 0.02, btn.label, 0.25, btn.action);
            panel.appendChild(b);
        });
        
        createVRSeekBar(panel);
        cameraRig.appendChild(panel);
        console.log('‚úì VR Panel olu≈üturuldu');
    }

    function createVRButton(x, y, z, label, size, onClick) {
        const btn = document.createElement('a-entity');
        btn.setAttribute('position', `${x} ${y} ${z}`);
        
        const circle = document.createElement('a-circle');
        circle.setAttribute('radius', size / 2);
        circle.setAttribute('color', '#44f');
        circle.setAttribute('class', 'clickable');
        btn.appendChild(circle);
        
        const text = document.createElement('a-text');
        text.setAttribute('value', label);
        text.setAttribute('align', 'center');
        text.setAttribute('width', size * 2);
        text.setAttribute('position', '0 0 0.01');
        text.setAttribute('color', '#fff');
        btn.appendChild(text);
        
        circle.addEventListener('mouseenter', () => {
            circle.setAttribute('color', '#66f');
            circle.setAttribute('radius', size / 2 * 1.1);
        });
        
        circle.addEventListener('mouseleave', () => {
            circle.setAttribute('color', '#44f');
            circle.setAttribute('radius', size / 2);
        });
        
        circle.addEventListener('click', onClick);
        return btn;
    }

    function createVRSeekBar(panel) {
        const seekBar = document.createElement('a-entity');
        seekBar.setAttribute('position', '0 -1.2 0.02');
        
        const bgBar = document.createElement('a-plane');
        bgBar.setAttribute('width', VR_UI_CONFIG.seekBarWidth);
        bgBar.setAttribute('height', '0.15');
        bgBar.setAttribute('color', '#555');
        bgBar.setAttribute('class', 'clickable');
        bgBar.setAttribute('id', 'vr-seekbar-bg');
        bgBar.addEventListener('click', (evt) => {
            if (!videoElement || !videoElement.duration) return;
            const intersection = evt.detail.intersection;
            if (!intersection) return;
            const localPoint = intersection.point;
            const seekBarWidth = VR_UI_CONFIG.seekBarWidth;
            const seekBarWorldPos = new THREE.Vector3();
            bgBar.object3D.getWorldPosition(seekBarWorldPos);
            const relativeX = localPoint.x - seekBarWorldPos.x;
            const percentage = (relativeX + seekBarWidth / 2) / seekBarWidth;
            const clamped = Math.max(0, Math.min(1, percentage));
            console.log('üéØ Seek bar:', (clamped * 100).toFixed(1), '%');
            seekToPosition(clamped);
        });
        seekBar.appendChild(bgBar);
        
        const progressBar = document.createElement('a-plane');
        progressBar.setAttribute('id', 'vr-progress-bar');
        progressBar.setAttribute('width', '0');
        progressBar.setAttribute('height', '0.15');
        progressBar.setAttribute('color', '#0f0');
        progressBar.setAttribute('position', `-${VR_UI_CONFIG.seekBarWidth / 2} 0 0.01`);
        seekBar.appendChild(progressBar);
        
        const timeText = document.createElement('a-text');
        timeText.setAttribute('id', 'vr-time-text');
        timeText.setAttribute('value', '0:00 / 0:00');
        timeText.setAttribute('align', 'center');
        timeText.setAttribute('width', '2');
        timeText.setAttribute('position', '0 -0.2 0.01');
        timeText.setAttribute('color', '#fff');
        seekBar.appendChild(timeText);
        
        setInterval(updateVRSeekBar, 500);
        panel.appendChild(seekBar);
    }

    function updateVRSeekBar() {
        if (!videoElement) return;
        const current = videoElement.currentTime;
        const duration = videoElement.duration;
        if (duration > 0) {
            const progress = current / duration;
            const progressBar = document.querySelector('#vr-progress-bar');
            const timeText = document.querySelector('#vr-time-text');
            if (progressBar) {
                progressBar.setAttribute('width', VR_UI_CONFIG.seekBarWidth * progress);
                progressBar.setAttribute('position',
                    `${-VR_UI_CONFIG.seekBarWidth / 2 + (VR_UI_CONFIG.seekBarWidth * progress) / 2} 0 0.01`
                );
            }
            if (timeText) {
                timeText.setAttribute('value',
                    `${formatTime(current)} / ${formatTime(duration)}`
                );
            }
        }
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function moveScreen(dir) {
        const screen = document.getElementById('video-screen');
        if (!screen) return;
        const step = 0.5;
        if (dir === 'up') screenPosition.y += step;
        else if (dir === 'down') screenPosition.y -= step;
        else if (dir === 'left') screenPosition.x -= step;
        else if (dir === 'right') screenPosition.x += step;
        else if (dir === 'forward') screenPosition.z += step;
        else if (dir === 'backward') screenPosition.z -= step;
        else if (dir === 'reset') screenPosition = { x: 0, y: 2, z: -10 };
        screen.setAttribute('position', `${screenPosition.x} ${screenPosition.y} ${screenPosition.z}`);
        console.log('‚úì Ekran:', screenPosition);
    }

    // KLAVYE KISAYOLLARI
    document.addEventListener('keydown', (e) => {
        if (!currentRoomId || !videoElement) return;
        if (e.code === 'Space' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
            e.preventDefault();
            videoElement.paused ? playVideo() : pauseVideo();
        }
        if (e.code === 'ArrowRight') { e.preventDefault(); seekVideo(10); }
        if (e.code === 'ArrowLeft') { e.preventDefault(); seekVideo(-10); }
        if (e.code === 'ArrowUp') moveScreen('up');
        if (e.code === 'ArrowDown') moveScreen('down');
        if (e.code === 'KeyW') moveScreen('up');
        if (e.code === 'KeyS') moveScreen('down');
        if (e.code === 'KeyA') moveScreen('left');
        if (e.code === 'KeyD') moveScreen('right');
        if (e.code === 'KeyR') moveScreen('reset');
        if (e.code === 'KeyM') { e.preventDefault(); videoElement.muted = !videoElement.muted; }
        if (e.code === 'KeyF') {
            e.preventDefault();
            const scene = document.querySelector('a-scene');
            if (document.fullscreenElement) document.exitFullscreen();
            else scene.requestFullscreen();
        }
    });

    // CLEANUP
    window.addEventListener('beforeunload', () => {
        if (keyframeInterval) clearInterval(keyframeInterval);
        if (syncTimeout) clearTimeout(syncTimeout);
        if (seekDebounceTimeout) clearTimeout(seekDebounceTimeout);
        if (roomRef) roomRef.off();
        if (videoElement) { videoElement.pause(); videoElement.src = ''; }
    });

    // Sayfa y√ºklendiƒüinde odalarƒ± listele
    window.addEventListener('load', () => {
        listRooms();
    });

    console.log('‚úì VR Sinema Ultra y√ºklendi - 10sn Sync | 7sn Keyframe');
    </script>
</body>
</html>
