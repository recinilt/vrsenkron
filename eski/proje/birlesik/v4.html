<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ VR Sosyal Sinema - Ultimate v4.0</title>
    
    <!-- A-Frame VR -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<style>
/* ============================================
   VR SOSYAL SÄ°NEMA - KOMPLE STILLER
   ============================================ */
body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
}

#ui-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: opacity 0.5s;
}

#ui-overlay.hidden {
    opacity: 0;
    pointer-events: none;
}

.ui-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 40px;
    max-width: 700px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

h1 {
    color: #667eea;
    margin-top: 0;
    font-size: 2em;
    text-align: center;
}

h2 {
    color: #444;
    font-size: 1.3em;
    margin-top: 30px;
    border-bottom: 2px solid #667eea;
    padding-bottom: 10px;
}

input, select, textarea {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    box-sizing: border-box;
    transition: border 0.3s;
    font-family: inherit;
}

textarea {
    min-height: 80px;
    resize: vertical;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #667eea;
}

button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 14px 28px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    margin: 5px;
    transition: transform 0.2s, box-shadow 0.2s;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

button:active {
    transform: translateY(0);
}

button.secondary {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

button.danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
}

button.stop {
    background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
}

.room-item {
    background: #f8f9fa;
    padding: 15px;
    margin: 10px 0;
    border-radius: 10px;
    border-left: 4px solid #667eea;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
}

.room-item:hover {
    transform: translateX(5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.room-item.private {
    border-left-color: #f5576c;
}

.room-item.ownerless {
    border-left-color: #ffa500;
    opacity: 0.8;
}

.room-name {
    font-weight: bold;
    font-size: 1.1em;
    color: #333;
}

.room-info {
    font-size: 0.9em;
    color: #666;
    margin-top: 5px;
}

.lock-icon {
    float: right;
    color: #f5576c;
}

.badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.75em;
    font-weight: 600;
    margin-left: 8px;
}

.badge-ownerless {
    background: #ffa500;
    color: white;
}

#vr-controls {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    background: rgba(0, 0, 0, 0.8);
    padding: 15px 25px;
    border-radius: 15px;
    display: none;
}

#vr-controls.visible {
    display: block;
}

#vr-controls button {
    margin: 0 5px;
    font-size: 14px;
    padding: 10px 20px;
}

.status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 5px;
}

.status-indicator.connected {
    background: #4caf50;
}

.status-indicator.syncing {
    background: #ff9800;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

#room-info-display {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    z-index: 100;
    display: none;
}

#room-info-display.visible {
    display: block;
}

.checkbox-container {
    display: flex;
    align-items: center;
    margin: 15px 0;
}

.checkbox-container input[type="checkbox"] {
    width: auto;
    margin-right: 10px;
}

.radio-container {
    margin: 15px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.radio-container label {
    display: block;
    margin: 8px 0;
    cursor: pointer;
}

.radio-container input[type="radio"] {
    width: auto;
    margin-right: 8px;
}

.info-box {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 12px;
    margin: 15px 0;
    border-radius: 5px;
    font-size: 0.9em;
}

.warning-box {
    background: #fff3e0;
    border-left: 4px solid #ff9800;
    padding: 12px;
    margin: 15px 0;
    border-radius: 5px;
    font-size: 0.9em;
}

.error-box {
    background: #ffebee;
    border-left: 4px solid #f44336;
    padding: 12px;
    margin: 15px 0;
    border-radius: 5px;
    font-size: 0.9em;
}

.loading {
    text-align: center;
    padding: 20px;
    color: #666;
}

.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

#sync-status {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 20px 40px;
    border-radius: 15px;
    font-size: 1.2em;
    z-index: 999;
    display: none;
}

@media (max-width: 768px) {
    .ui-container {
        padding: 20px;
    }
    h1 {
        font-size: 1.5em;
    }
    #vr-controls {
        bottom: 10px;
        padding: 10px 15px;
    }
    #vr-controls button {
        font-size: 12px;
        padding: 8px 15px;
    }
    #room-info-display {
        top: 10px;
        right: 10px;
        font-size: 0.9em;
        padding: 10px 15px;
    }
}

.ui-container::-webkit-scrollbar {
    width: 8px;
}

.ui-container::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 10px;
}

.ui-container::-webkit-scrollbar-thumb {
    background: #667eea;
    border-radius: 10px;
}

.ui-container::-webkit-scrollbar-thumb:hover {
    background: #764ba2;
}
</style>
</head>
<body>

<!-- UI Overlay -->
<div id="ui-overlay">
    <div class="ui-container">
        <div id="main-menu">
            <h1>ğŸ¬ VR Sosyal Sinema</h1>
            <p style="text-align: center; color: #666;">âš¡ Ultimate Versiyon v4.0</p>
            <p style="text-align: center; font-size: 0.9em; color: #888;">
                ğŸ¥ Ã‡ok Format | ğŸ“ AltyazÄ± | ğŸ® VR Kontrol | ğŸ“º YouTube/Drive
            </p>
            
            <h2>HoÅŸ Geldiniz</h2>
            <button onclick="showCreateRoom()" style="width: 100%; margin: 10px 0;">â• Yeni Oda OluÅŸtur</button>
            <button onclick="showRoomList()" class="secondary" style="width: 100%; margin: 10px 0;">ğŸšª Odalara GÃ¶zat</button>
        </div>

        <div id="create-room-menu" style="display: none;">
            <h1>Yeni Oda OluÅŸtur</h1>
            
            <div class="info-box">
                <strong>Desteklenen Formatlar:</strong><br>
                <strong>Video:</strong> MP4, WebM, OGG, MKV, AVI, MOV, FLV, TS, M3U8<br>
                <strong>AltyazÄ±:</strong> SRT, VTT, ASS, SSA, SUB<br>
                <strong>Platformlar:</strong> YouTube, Google Drive, Cloudinary, Zerostorage, Catbox, Bunny CDN
            </div>

            <label for="room-name-input">ğŸ  Oda AdÄ±:</label>
            <input type="text" id="room-name-input" placeholder="Ã–rn: Film Gecesi">

            <label for="video-url-input">ğŸ¥ Video URL:</label>
            <input type="text" id="video-url-input" placeholder="Video linki girin">

            <label for="subtitle-url-input">ğŸ“ AltyazÄ± URL (Opsiyonel):</label>
            <input type="text" id="subtitle-url-input" placeholder="SRT, VTT, ASS, SSA formatlarÄ± desteklenir">

            <div class="checkbox-container">
                <input type="checkbox" id="private-room">
                <label for="private-room">ğŸ”’ Ã–zel Oda (Åifre KorumalÄ±)</label>
            </div>
            <input type="password" id="room-password" placeholder="Åifre (opsiyonel)" style="display: none;">

            <label for="screen-size">Ekran Tipi:</label>
            <select id="screen-size">
                <option value="flat">DÃ¼z Ekran (16:9)</option>
                <option value="360">360Â° Video</option>
                <option value="180">180Â° Video</option>
            </select>

            <div class="radio-container">
                <strong>ğŸ® Video KontrolÃ¼:</strong><br>
                <label><input type="radio" name="control-mode" value="owner" checked> Sadece oda sahibi kontrol edebilir</label>
                <label><input type="radio" name="control-mode" value="everyone"> Herkes kontrol edebilir</label>
            </div>

            <label>ğŸ­ Sinema OrtamÄ± SeÃ§in (5 Hafif Ortam)</label>
            <label for="environment-select">Ortam:</label>
            <select id="environment-select">
                <option value="none">OrtamsÄ±z (En Hafif)</option>
                <option value="default" selected>Klasik Sinema</option>
                <option value="forest">Orman</option>
                <option value="starry">YÄ±ldÄ±zlÄ± Gece</option>
                <option value="goaland">GÃ¶kyÃ¼zÃ¼ AdasÄ±</option>
            </select>

            <button onclick="createRoom()" style="width: 100%; margin-top: 20px;">ğŸ¬ Oda OluÅŸtur ve BaÅŸlat</button>
            <button onclick="showMainMenu()" class="secondary" style="width: 100%; margin-top: 10px;">â—€ Geri</button>
        </div>

        <div id="room-list-menu" style="display: none;">
            <h1>Aktif Odalar</h1>
            <div id="rooms-list">
                <p class="loading">â³ Odalar yÃ¼kleniyor...</p>
            </div>
            <button onclick="listRooms()" class="secondary" style="width: 100%; margin-top: 20px;">ğŸ”„ Manuel Yenile</button>
            <button onclick="showMainMenu()" class="secondary" style="width: 100%; margin-top: 10px;">â—€ Geri</button>
        </div>
    </div>
</div>

<!-- VR Kontrolleri (Desktop) -->
<div id="vr-controls">
    <button onclick="togglePlayPause()">â–¶ Play/Pause</button>
    <button onclick="stopVideo()" class="stop">â¹ Durdur (BaÅŸa Sar)</button>
    <button onclick="leaveRoom()" class="danger">ğŸšª Odadan Ã‡Ä±k</button>
</div>

<!-- Oda Bilgi Paneli -->
<div id="room-info-display">
    <strong>Oda: <span id="room-name">-</span></strong><br>
    <span class="status-indicator connected"></span>
    <span id="viewers-count">0</span> Ä°zleyici<br>
    <strong>Kontrol Modu: <span id="control-mode">-</span></strong>
</div>

<!-- Sync Status -->
<div id="sync-status"></div>

<!-- VR Scene -->
<a-scene cursor="rayOrigin: mouse" raycaster="objects: .clickable">
    <!-- Kamera -->
    <a-entity id="camera-rig" position="0 1.6 0">
        <a-camera look-controls wasd-controls="acceleration: 20"></a-camera>
    </a-entity>

    <!-- Video EkranÄ± -->
    <a-plane id="video-screen" position="0 2 -10" width="16" height="9" visible="false"></a-plane>

    <!-- Ortam - Dinamik yÃ¼klenecek -->
    <a-entity id="environment-entity"></a-entity>

    <!-- Zemin -->
    <a-plane position="0 0 0" rotation="-90 0 0" width="100" height="100" color="#1a1a2e"></a-plane>
</a-scene>

<script>
// ============================================
// YENÄ° FIREBASE CONFIGURATION
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyC60idSLdAiqAjPWAOMaM3g8LAKPGEUwH8",
    authDomain: "vr-sinema.firebaseapp.com",
    databaseURL: "https://vr-sinema-default-rtdb.firebaseio.com",
    projectId: "vr-sinema",
    storageBucket: "vr-sinema.firebasestorage.app",
    messagingSenderId: "724648238300",
    appId: "1:724648238300:web:dceba8c536e8a5ffd96819"
};

// ============================================
// FIREBASE BAÅLAT
// ============================================
firebase.initializeApp(firebaseConfig);
console.log('âœ“ Firebase baÅŸlatÄ±ldÄ±:', firebaseConfig.projectId);

const CLOUDFLARE_WORKER = 'https://mefeypublicv2.recepyeni.workers.dev';
const SYNC_DELAY = 3000;
const SUPPORTED_VIDEO_FORMATS = ['mp4', 'webm', 'ogg', 'mov', 'avi', 'mkv', 'm4v', 'flv', '3gp', 'wmv', 'ts', 'm3u8'];
const SUPPORTED_SUBTITLE_FORMATS = ['srt', 'vtt', 'ass', 'ssa', 'sub'];

const ENVIRONMENTS = {
'none': { name: 'OrtamsÄ±z', preset: null, color: '#1a1a2e', weight: 0 },
'default': { name: 'Klasik Sinema', preset: 'default', color: '#1a1a2e', weight: 1 },
'forest': { name: 'Orman', preset: 'forest', color: '#2d5016', weight: 2 },
'starry': { name: 'YÄ±ldÄ±zlÄ± Gece', preset: 'starry', color: '#191970', weight: 1 },
'goaland': { name: 'GÃ¶kyÃ¼zÃ¼ AdasÄ±', preset: 'goaland', color: '#87ceeb', weight: 2 }
};

const VIDEO_SERVICES = {
youtube: {
pattern: /(youtu\.be\/|youtube\.com\/(watch\?v=|embed\/|v\/|shorts\/))([\w-]{11})/,
transform: (match) => `https://www.youtube.com/embed/${match[3]}?autoplay=1&controls=1&enablejsapi=1`
},
googledrive: {
pattern: /drive\.google\.com\/(?:file\/d\/|open\?id=|uc\?id=)([a-zA-Z0-9_-]+)/,
transform: (match) => {
const fileId = match[1];
const directUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
return `${CLOUDFLARE_WORKER}?url=${encodeURIComponent(directUrl)}`;
}
},
zerostorage: {
pattern: /zerostorage\.net\/(?:embed\/|file\/)([a-zA-Z0-9-]+)/,
transform: (match) => `https://zerostorage.net/file/${match[1]}`
},
cloudinary: {
pattern: /res\.cloudinary\.com\/([^\/]+)\/video\/upload\//,
transform: (url) => url
},
bunny: {
pattern: /(bunnycdn|b-cdn)\.net/,
transform: (url) => url
},
catbox: {
pattern: /catbox\.moe/,
transform: (url) => url
}
};

const VR_UI_CONFIG = {
position: { x: -5, y: 1.6, z: -3 },
rotation: { x: 0, y: 90, z: 0 },
scale: 0.7,
buttonSize: 0.28,
seekBarWidth: 1.8
};

// ============================================
// GLOBAL VARIABLES
// ============================================
let database = firebase.database();
let auth = firebase.auth();
let roomsRef = database.ref('rooms');
let roomRef = null;
let videoElement = null;
let currentEnvironment = 'default';
let currentSubtitleTrack = null;
let currentRoomId = null;
let currentRoomData = null;
let isRoomOwner = false;
let viewerPresenceRef = null;
let syncTimeout = null;
let lastSyncTime = 0;
let uiOverlay = null;
let vrControls = null;
let roomInfoDisplay = null;
let vrUIPanel = null;
let vrSeekBar = null;
let subtitleElement = null;
let subtitleData = null;
let subtitleUpdateInterval = null;
let screenPosition = { x: 0, y: 2, z: -10 };
let screenRotation = { x: 0, y: 0, z: 0 };

// ============================================
// UTILITY FUNCTIONS
// ============================================
function throttle(func, delay) {
let lastCall = 0;
return function(...args) {
const now = Date.now();
if (now - lastCall >= delay) {
lastCall = now;
func(...args);
}
};
}

function debounce(func, delay) {
let timeout;
return function(...args) {
clearTimeout(timeout);
timeout = setTimeout(() => func(...args), delay);
};
}

function showSyncStatus(message) {
const statusDiv = document.getElementById('sync-status');
if (statusDiv) {
statusDiv.textContent = message;
statusDiv.style.display = 'block';
setTimeout(() => {
statusDiv.style.display = 'none';
}, 3000);
}
}

function showOverlay() {
if (uiOverlay) uiOverlay.classList.remove('hidden');
}

function hideOverlay() {
if (uiOverlay) uiOverlay.classList.add('hidden');
}

function showVRControls() {
if (vrControls) vrControls.classList.add('visible');
}

function hideVRControls() {
if (vrControls) vrControls.classList.remove('visible');
}

function showRoomInfo() {
if (roomInfoDisplay) roomInfoDisplay.classList.add('visible');
}

function hideRoomInfo() {
if (roomInfoDisplay) roomInfoDisplay.classList.remove('visible');
}

const updateRoomInfoDisplay = throttle(function() {
if (!currentRoomData || !roomInfoDisplay) return;
const roomName = document.getElementById('room-name');
const viewersCount = document.getElementById('viewers-count');
const controlMode = document.getElementById('control-mode');
if (roomName) roomName.textContent = currentRoomData.name;
if (viewersCount) viewersCount.textContent = currentRoomData.viewers || 0;
if (controlMode) {
controlMode.textContent = currentRoomData.controlMode === 'owner' ? 'Sadece Sahip' : 'Herkes';
}
}, 3000);

// ============================================
// UI NAVIGATION
// ============================================
function showMainMenu() {
document.getElementById('main-menu').style.display = 'block';
document.getElementById('create-room-menu').style.display = 'none';
document.getElementById('room-list-menu').style.display = 'none';
}

function showCreateRoom() {
document.getElementById('main-menu').style.display = 'none';
document.getElementById('create-room-menu').style.display = 'block';
document.getElementById('room-list-menu').style.display = 'none';
}

function showRoomList() {
document.getElementById('main-menu').style.display = 'none';
document.getElementById('create-room-menu').style.display = 'none';
document.getElementById('room-list-menu').style.display = 'block';
listRooms();
}

// ============================================
// VIDEO DETECTION
// ============================================
function detectVideoService(url) {
if (!url) return 'unknown';
for (const [service, config] of Object.entries(VIDEO_SERVICES)) {
if (config.pattern.test(url)) return service;
}
if (url.includes('.mp4') || url.includes('.webm') || url.includes('.ogg') ||
    url.includes('.ts') || url.includes('.m3u8')) {
return 'direct';
}
return 'unknown';
}

function getVideoUrl(inputUrl) {
if (!inputUrl) return null;
const service = detectVideoService(inputUrl);
console.log('ğŸ” AlgÄ±lanan servis:', service);
if (service === 'direct') return inputUrl;
if (VIDEO_SERVICES[service]) {
const config = VIDEO_SERVICES[service];
const match = inputUrl.match(config.pattern);
if (match) {
const transformedUrl = config.transform(match);
console.log('âœ“ DÃ¶nÃ¼ÅŸtÃ¼rÃ¼len URL:', transformedUrl);
return transformedUrl;
}
}
return inputUrl;
}

// ============================================
// VIDEO SETUP
// ============================================
function setupVideo(videoUrl, screenSize) {
console.log('ğŸ¬ Video ayarlanÄ±yor:', videoUrl);
const processedUrl = getVideoUrl(videoUrl);
if (!processedUrl) {
alert('âŒ GeÃ§ersiz video URL!');
return;
}

setupVideoTexture(processedUrl, screenSize);
}

function setupVideoTexture(videoUrl, screenSize) {
const scene = document.querySelector('a-scene');
const screen = document.getElementById('video-screen');
if (!screen) {
console.error('âŒ Ekran elementi bulunamadÄ±!');
return;
}

const size = {
'flat': { width: 16, height: 9 },
'360': { width: 100, height: 100 },
'180': { width: 50, height: 50 }
}[screenSize] || { width: 16, height: 9 };

if (screenSize === '360') {
screen.setAttribute('geometry', {
primitive: 'sphere',
radius: 50,
segmentsWidth: 64,
segmentsHeight: 64
});
screen.setAttribute('material', 'side: back');
screen.setAttribute('scale', '-1 1 1');
} else if (screenSize === '180') {
screen.setAttribute('geometry', {
primitive: 'sphere',
radius: 25,
segmentsWidth: 64,
segmentsHeight: 32,
thetaStart: 0,
thetaLength: 180
});
screen.setAttribute('material', 'side: back');
screen.setAttribute('scale', '-1 1 1');
} else {
screen.setAttribute('geometry', {
primitive: 'plane',
width: size.width,
height: size.height
});
screen.removeAttribute('scale');
}

let assets = document.querySelector('a-assets');
if (!assets) {
assets = document.createElement('a-assets');
scene.appendChild(assets);
}

const oldVideo = document.getElementById('video-src');
if (oldVideo) {
oldVideo.pause();
oldVideo.src = '';
oldVideo.remove();
}

const videoAsset = document.createElement('video');
videoAsset.id = 'video-src';
videoAsset.crossOrigin = 'anonymous';
videoAsset.preload = 'auto';
videoAsset.loop = false;
videoAsset.playsInline = true;
videoAsset.muted = false;

if (videoUrl.includes('.ts')) {
videoAsset.type = 'video/mp2t';
} else if (videoUrl.includes('.m3u8')) {
videoAsset.type = 'application/x-mpegURL';
}

assets.appendChild(videoAsset);
videoElement = videoAsset;

videoElement.addEventListener('canplay', () => {
console.log('âœ“ Video oynatmaya hazÄ±r');
screen.setAttribute('visible', 'true');
});

videoElement.addEventListener('error', (e) => {
console.error('âŒ Video yÃ¼kleme hatasÄ±:', e);
alert('âŒ Video yÃ¼klenemedi! URL\'yi kontrol edin.');
});

videoElement.src = videoUrl;
videoElement.load();
screen.setAttribute('src', '#video-src');
console.log('âœ“ Video elementi oluÅŸturuldu');
}

// ============================================
// VIDEO CONTROLS
// ============================================
function canControlVideo() {
if (!currentRoomData) return false;
if (currentRoomData.controlMode === 'everyone') return true;
return isRoomOwner;
}

function togglePlayPause() {
if (!canControlVideo()) {
alert('âš ï¸ Bu odada sadece oda sahibi video kontrolÃ¼ yapabilir!');
return;
}
if (!videoElement) {
alert('Video henÃ¼z yÃ¼klenmedi!');
return;
}

if (videoElement.paused) {
const startTimestamp = Date.now() + SYNC_DELAY;
roomRef.child('videoState').update({
isPlaying: true,
currentTime: videoElement.currentTime,
startTimestamp: startTimestamp,
lastUpdate: Date.now()
});
showSyncStatus('â±ï¸ 3 saniye sonra baÅŸlÄ±yor...');
console.log('â–¶ï¸ Video 3 saniye sonra baÅŸlatÄ±lacak');
} else {
videoElement.pause();
roomRef.child('videoState').update({
isPlaying: false,
currentTime: videoElement.currentTime,
startTimestamp: null,
lastUpdate: Date.now()
});
console.log('â¸ï¸ Video durduruldu');
}
}

function stopVideo() {
if (!canControlVideo()) {
alert('âš ï¸ Bu odada sadece oda sahibi video kontrolÃ¼ yapabilir!');
return;
}
if (!videoElement) {
alert('Video henÃ¼z yÃ¼klenmedi!');
return;
}

videoElement.pause();
videoElement.currentTime = 0;
roomRef.child('videoState').update({
isPlaying: false,
currentTime: 0,
startTimestamp: null,
lastUpdate: Date.now()
});
console.log('â¹ Video durduruldu ve baÅŸa sarÄ±ldÄ±');
showSyncStatus('â¹ Video baÅŸa sarÄ±ldÄ±');
}

// ============================================
// FIREBASE SYNC
// ============================================
function listenToRoomUpdates() {
if (!roomRef) return;

roomRef.child('videoState').on('value', (snapshot) => {
if (!videoElement) return;
const state = snapshot.val();
if (!state) return;

const now = Date.now();

if (!state.isPlaying) {
if (!videoElement.paused) {
videoElement.pause();
console.log('â¸ï¸ Video durduruldu (sync)');
}
if (Math.abs(videoElement.currentTime - state.currentTime) > 0.5) {
videoElement.currentTime = state.currentTime;
console.log(`ğŸ¯ Pozisyon senkronize: ${state.currentTime.toFixed(1)}s`);
}
return;
}

if (state.isPlaying && state.startTimestamp) {
const waitTime = state.startTimestamp - now;
if (waitTime > 100) {
console.log(`â±ï¸ ${(waitTime/1000).toFixed(1)}s sonra baÅŸlayacak`);
showSyncStatus(`â±ï¸ ${Math.ceil(waitTime/1000)}s sonra baÅŸlÄ±yor...`);
if (Math.abs(videoElement.currentTime - state.currentTime) > 0.5) {
videoElement.currentTime = state.currentTime;
}
if (!videoElement.paused) {
videoElement.pause();
}
if (syncTimeout) clearTimeout(syncTimeout);
syncTimeout = setTimeout(() => {
videoElement.currentTime = state.currentTime;
videoElement.play().then(() => {
console.log('â–¶ï¸ Video baÅŸlatÄ±ldÄ± (SENKRON)');
}).catch(err => {
console.log('Auto-play engellendi:', err);
});
}, waitTime);
} else if (waitTime > -1000) {
videoElement.currentTime = state.currentTime;
videoElement.play().catch(err => {
console.log('Auto-play engellendi:', err);
});
} else {
const elapsedSeconds = Math.abs(waitTime) / 1000;
const catchupTime = state.currentTime + elapsedSeconds;
videoElement.currentTime = catchupTime;
videoElement.play().catch(err => {
console.log('Auto-play engellendi:', err);
});
}
}
});

roomRef.child('owner').on('value', (snapshot) => {
const newOwner = snapshot.val();
if (newOwner === auth.currentUser.uid && !isRoomOwner) {
isRoomOwner = true;
console.log('âœ“ Oda sahipliÄŸi size devredildi!');
alert('ğŸ‰ Oda sahipliÄŸi size devredildi!');
}
});

console.log('âœ“ Senkronizasyon sistemi aktif');
}

// ============================================
// ROOM MANAGEMENT
// ============================================
function createRoom() {
const roomName = document.getElementById('room-name-input').value.trim();
const videoUrl = document.getElementById('video-url-input').value.trim();
const subtitleUrl = document.getElementById('subtitle-url-input').value.trim();
const environment = document.getElementById('environment-select').value;
const screenSize = document.getElementById('screen-size').value;
const isPrivate = document.getElementById('private-room').checked;
const roomPassword = document.getElementById('room-password').value.trim();
const controlMode = document.querySelector('input[name="control-mode"]:checked').value;

if (!roomName || !videoUrl) {
alert('âš ï¸ LÃ¼tfen oda adÄ± ve video URL\'si girin!');
return;
}

auth.signInAnonymously().then(() => {
const userId = auth.currentUser.uid;
const newRoomRef = roomsRef.push();
const roomId = newRoomRef.key;

const roomData = {
name: roomName,
videoUrl: videoUrl,
subtitleUrl: subtitleUrl || null,
environment: environment,
screenSize: screenSize,
owner: userId,
ownerName: roomName.split(' ')[0] || 'Anonim',
isPrivate: isPrivate,
password: isPrivate ? roomPassword : null,
controlMode: controlMode,
viewers: 1,
createdAt: Date.now(),
videoState: {
isPlaying: false,
currentTime: 0,
startTimestamp: null,
lastUpdate: Date.now()
}
};

newRoomRef.set(roomData).then(() => {
console.log('âœ“ Oda oluÅŸturuldu:', roomId);
joinRoom(roomId, roomPassword);
});
}).catch((error) => {
console.error('âŒ GiriÅŸ hatasÄ±:', error);
alert('âŒ GiriÅŸ yapÄ±lamadÄ±! Firebase Authentication aktif mi kontrol edin.');
});
}

function joinRoom(roomId, password = null) {
roomsRef.child(roomId).once('value').then((snapshot) => {
const room = snapshot.val();
if (!room) {
alert('âš ï¸ Oda bulunamadÄ±!');
return;
}

if (room.isPrivate && room.password !== password) {
const enteredPassword = prompt('ğŸ”’ Bu oda ÅŸifrelidir. Åifreyi girin:');
if (enteredPassword !== room.password) {
alert('âŒ YanlÄ±ÅŸ ÅŸifre!');
return;
}
}

auth.signInAnonymously().then(() => {
const userId = auth.currentUser.uid;
currentRoomId = roomId;
currentRoomData = room;
roomRef = roomsRef.child(roomId);
isRoomOwner = (room.owner === userId);

if (room.password) {
roomRef.child('password').remove();
}

roomRef.child('viewers').transaction((current) => {
return (current || 0) + 1;
});

viewerPresenceRef = database.ref('.info/connected');
viewerPresenceRef.on('value', (snap) => {
if (snap.val() === true) {
const myPresenceRef = roomRef.child('activeViewers').child(userId);
myPresenceRef.onDisconnect().remove();
myPresenceRef.set({
timestamp: Date.now(),
isOwner: isRoomOwner
});

const viewersRef = roomRef.child('viewers');
viewersRef.onDisconnect().set(firebase.database.ServerValue.increment(-1));

if (isRoomOwner) {
const ownerRef = roomRef.child('owner');
ownerRef.onDisconnect().remove();
}
}
});

currentEnvironment = room.environment;
setupVideo(room.videoUrl, room.screenSize);

setTimeout(() => {
const envEntity = document.getElementById('environment-entity');
if (envEntity && room.environment !== 'none') {
try {
envEntity.setAttribute('environment', {
preset: room.environment,
lighting: 'distant'
});
console.log('âœ“ Environment yÃ¼klendi:', room.environment);
} catch(e) {
console.warn('âš ï¸ Environment yÃ¼klenemedi');
}
}
}, 1000);

hideOverlay();
showVRControls();
showRoomInfo();
updateRoomInfoDisplay();
listenToRoomUpdates();

console.log('âœ“ Odaya katÄ±ldÄ±nÄ±z:', roomId);
console.log('ğŸ‘‘ Oda sahibi:', isRoomOwner ? 'Evet' : 'HayÄ±r');
});
});
}

function listRooms() {
roomsRef.once('value').then((snapshot) => {
const rooms = snapshot.val();
const roomsList = document.getElementById('rooms-list');
roomsList.innerHTML = '';

if (!rooms) {
roomsList.innerHTML = '<p class="loading">HenÃ¼z oda yok. Ä°lk odayÄ± siz oluÅŸturun! ğŸ¬</p>';
return;
}

let roomCount = 0;
Object.entries(rooms).forEach(([roomId, room]) => {
if (room.isPrivate) return;

const isOwnerless = !room.owner;
roomCount++;

const roomDiv = document.createElement('div');
roomDiv.className = `room-item${isOwnerless ? ' ownerless' : ''}`;
roomDiv.onclick = () => joinRoom(roomId);

const subtitleBadge = room.subtitleUrl ? ' | ğŸ“ AltyazÄ±' : '';
const ownerlessBadge = isOwnerless ? '<span class="badge badge-ownerless">Sahipsiz</span>' : '';

roomDiv.innerHTML = `
<div class="room-name">${room.name || 'Ä°simsiz Oda'}${ownerlessBadge}</div>
<div class="room-info">
ğŸ‘¥ ${room.viewers || 0} Ä°zleyici | 
ğŸ­ ${ENVIRONMENTS[room.environment]?.name || 'Bilinmeyen'}${subtitleBadge}
</div>
`;
roomsList.appendChild(roomDiv);
});

if (roomCount === 0) {
roomsList.innerHTML = '<p class="loading">HiÃ§ aÃ§Ä±k oda yok. Ä°lk odayÄ± siz oluÅŸturun! ğŸ¬</p>';
}
});
}

function leaveRoom() {
if (videoElement) {
videoElement.pause();
videoElement.src = '';
}
if (roomRef) {
roomRef.off();
}
if (viewerPresenceRef) {
viewerPresenceRef.off();
}
currentRoomId = null;
currentRoomData = null;
isRoomOwner = false;
hideVRControls();
hideRoomInfo();
showOverlay();
showMainMenu();
console.log('ğŸ‘‹ Odadan Ã§Ä±kÄ±ldÄ±');
}

// ============================================
// INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', () => {
console.log('âœ“ DOM yÃ¼klendi');

uiOverlay = document.getElementById('ui-overlay');
vrControls = document.getElementById('vr-controls');
roomInfoDisplay = document.getElementById('room-info-display');

document.getElementById('private-room').addEventListener('change', function() {
const passwordInput = document.getElementById('room-password');
passwordInput.style.display = this.checked ? 'block' : 'none';
});

const scene = document.querySelector('a-scene');
if (scene) {
scene.addEventListener('loaded', () => {
console.log('âœ“ VR sahnesi yÃ¼klendi');
});

scene.addEventListener('enter-vr', () => {
console.log('âœ“ VR moduna girildi');
hideVRControls();
});

scene.addEventListener('exit-vr', () => {
console.log('âœ“ VR modundan Ã§Ä±kÄ±ldÄ±');
if (currentRoomId) {
showVRControls();
}
});
}

document.addEventListener('keydown', (e) => {
if (!currentRoomId || !videoElement) return;

if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
e.preventDefault();
togglePlayPause();
}

if (e.code === 'KeyM') {
e.preventDefault();
videoElement.muted = !videoElement.muted;
console.log('ğŸ”‡ Sessiz:', videoElement.muted);
}

if (e.code === 'KeyF') {
e.preventDefault();
const sceneEl = document.querySelector('a-scene');
if (sceneEl) {
if (document.fullscreenElement) {
document.exitFullscreen();
} else {
sceneEl.requestFullscreen();
}
}
}
});

console.log('âœ“ Event listener\'lar kuruldu');
console.log('ğŸ® Klavye KÄ±sayollarÄ±:');
console.log(' Space: Oynat/Duraklat');
console.log(' M: Sessiz');
console.log(' F: Tam Ekran');
});

window.addEventListener('beforeunload', () => {
if (viewerPresenceRef) {
viewerPresenceRef.off();
}
if (roomRef) {
roomRef.off();
}
if (videoElement) {
videoElement.pause();
videoElement.src = '';
}
console.log('ğŸ‘‹ BaÄŸlantÄ± kesiliyor...');
});

console.log('âœ“ VR Sosyal Sinema - Ultimate v4.0 YÃ¼klendi');
</script>

</body>
</html>
