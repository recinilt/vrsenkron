<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VR Sinema - Global Sync Core</title>
    
    <!-- A-FRAME & COMPONENTS -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
    
    <!-- FIREBASE (ModÃ¼ler SDK yerine Compat kullanÄ±yoruz, tek dosya kolaylÄ±ÄŸÄ± iÃ§in) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        /* MODERN DARK UI */
        :root {
            --primary: #f53b57;
            --secondary: #3c40c6;
            --dark: #1e272e;
            --light: #d2dae2;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #000;
            color: var(--light);
            overflow: hidden;
        }

        /* GÄ°RÄ°Åž EKRANI / LOBÄ° */
        #lobby-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #2f3640 0%, #000000 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.8s cubic-bezier(0.86, 0, 0.07, 1);
        }

        #lobby-overlay.hidden {
            transform: translateY(-100%);
            pointer-events: none;
        }

        .panel {
            background: rgba(30, 39, 46, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 50px rgba(245, 59, 87, 0.2);
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        h1 {
            margin: 0 0 1rem 0;
            font-weight: 800;
            background: linear-gradient(to right, #f53b57, #3c40c6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #808e9b;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #485460;
            background: #000;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(245, 59, 87, 0.2);
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        button:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(245, 59, 87, 0.4);
        }

        /* HUD & BÄ°LGÄ° PANCERELERÄ° */
        #hud {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 100;
            pointer-events: none; /* TÄ±klamalarÄ± VR'a geÃ§ir */
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        #hud.visible { opacity: 1; }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00d2d3;
            box-shadow: 0 0 10px #00d2d3;
        }

        .viewer-count {
            font-weight: bold;
            font-family: monospace;
        }

        /* LOADING SPINNER */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MUTE WARNING */
        #click-to-start {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 8000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            display: none;
        }
    </style>
</head>
<body>

    <!-- LOBI ARAYÃœZÃœ -->
    <div id="lobby-overlay">
        <div class="panel">
            <h1>ðŸŽ¬ VR Sync Core</h1>
            
            <div class="input-group">
                <label>KullanÄ±cÄ± AdÄ±</label>
                <input type="text" id="username" placeholder="Ä°sminiz..." maxlength="15">
            </div>

            <div class="input-group">
                <label>Oda Kodu (BoÅŸ bÄ±rakÄ±rsanÄ±z yeni oda oluÅŸturulur)</label>
                <input type="text" id="room-id" placeholder="Ã¶rn: movie-night">
            </div>

            <div class="input-group" id="owner-controls">
                <label>Video URL (.mp4, .webm veya direkt link)</label>
                <input type="text" id="video-url" value="http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" placeholder="https://...">
            </div>

            <button onclick="enterCinema()">SÄ°NEMAYA GÄ°R</button>
            <div class="loader" id="loader"></div>
            <p style="margin-top:10px; font-size:0.8rem; opacity:0.6;">20+ KiÅŸi Senkron Destekli</p>
        </div>
    </div>

    <!-- START INTERACTION OVERLAY (Browser Audio Policy) -->
    <div id="click-to-start" onclick="unlockAudio()">
        <div>ðŸ”Š Sesi AÃ§mak Ä°Ã§in TÄ±klayÄ±n</div>
    </div>

    <!-- HUD -->
    <div id="hud">
        <div class="status-dot" id="sync-dot"></div>
        <div class="viewer-count">ðŸ‘¥ <span id="viewer-count-display">0</span></div>
        <div style="font-size:0.8rem; opacity:0.7" id="debug-text">Syncing...</div>
    </div>

    <!-- VR SAHNESÄ° -->
    <a-scene loading-screen="dotsColor: #f53b57; backgroundColor: #000" vr-mode-ui="enabled: true">
        
        <!-- VARLIKLAR -->
        <a-assets>
            <video id="main-video" loop="false" crossorigin="anonymous" playsinline webkit-playsinline></video>
            <!-- Koltuk Modeli (Basit Geometri) -->
            <a-mixin id="seat" geometry="primitive: box; width: 0.6; height: 0.5; depth: 0.6" material="color: #57606f"></a-mixin>
            <!-- Avatar Modeli -->
            <a-mixin id="avatar-head" geometry="primitive: sphere; radius: 0.25" material="color: #ff6b6b"></a-mixin>
        </a-assets>

        <!-- ORTAM & IÅžIK -->
        <a-entity environment="preset: starry; lighting: distant; groundColor: #101010; grid: none"></a-entity>
        <a-light type="ambient" color="#222"></a-light>
        <a-light type="point" position="0 4 0" intensity="0.5" color="#fff"></a-light>

        <!-- SÄ°NEMA SALONU YAPISI (HAFÄ°F MODEL) -->
        <a-entity id="cinema-structure">
            <!-- Ekran Ã‡erÃ§evesi -->
            <a-box position="0 3 -9.1" width="16.5" height="9.5" depth: "0.1" color="#000"></a-box>
            <!-- Zemin -->
            <a-plane position="0 0.1 -5" rotation="-90 0 0" width="20" height="20" color="#111"></a-plane>
        </a-entity>

        <!-- VÄ°DEO EKRANI (DEV & KAVÄ°SLÄ°) -->
        <!-- Curved plane kullanÄ±mÄ± daha iyi immersion saÄŸlar -->
        <a-entity id="video-display" 
                  geometry="primitive: cylinder; openEnded: true; thetaLength: 60; thetaStart: 150; radius: 12; height: 9" 
                  material="src: #main-video; side: double; shader: flat"
                  position="0 3 -4"
                  scale="-1 1 1"></a-entity> <!-- Scale -1 videoyu dÃ¼zeltir -->

        <!-- OYUNCU (CAMERA) -->
        <a-entity id="camera-rig" position="0 1.6 0">
            <a-camera id="local-camera" look-controls="pointerLockEnabled: false">
                <a-cursor color="#f53b57" scale="0.5 0.5 0.5"></a-cursor>
            </a-camera>
            <!-- Eller (VR Controller) -->
            <a-entity laser-controls="hand: left"></a-entity>
            <a-entity laser-controls="hand: right"></a-entity>
        </a-entity>

        <!-- DÄ°ÄžER KULLANICILAR (AVATAR KONTEYNERÄ°) -->
        <a-entity id="avatar-container"></a-entity>

        <!-- VR KONTROL PANELÄ° (Sadece Oda Sahibi GÃ¶rÃ¼r) -->
        <a-entity id="vr-controls" position="0 1.2 -1.5" rotation="-20 0 0" scale="0.5 0.5 0.5" visible="false">
            <a-plane width="3" height="1" color="#000" opacity="0.8" rx-border-radius="0.1"></a-plane>
            
            <!-- Play/Pause -->
            <a-entity position="-0.8 0 0.1" geometry="primitive: circle; radius: 0.2" material="color: #2ed573" 
                      class="clickable" onclick="togglePlay()">
                <a-text value="PLAY/PAUSE" align="center" scale="0.8 0.8 0.8"></a-text>
            </a-entity>

            <!-- Geri 10s -->
            <a-entity position="0 0 0.1" geometry="primitive: circle; radius: 0.15" material="color: #ffa502" 
                      class="clickable" onclick="seekRelative(-10)">
                <a-text value="-10s" align="center"></a-text>
            </a-entity>

            <!-- Ä°leri 10s -->
            <a-entity position="0.5 0 0.1" geometry="primitive: circle; radius: 0.15" material="color: #ffa502" 
                      class="clickable" onclick="seekRelative(10)">
                <a-text value="+10s" align="center"></a-text>
            </a-entity>
            
            <!-- Sync Reset -->
            <a-entity position="1.1 0 0.1" geometry="primitive: box; width: 0.4; height: 0.2" material="color: #ff4757" 
                      class="clickable" onclick="forceSync()">
                <a-text value="SYNC" align="center" scale="0.5 0.5 0.5" z-offset="0.1"></a-text>
            </a-entity>
        </a-entity>

    </a-scene>

    <script>
        // ==========================================
        // CONFIG & INIT
        // ==========================================
        // KullanÄ±cÄ±nÄ±n saÄŸladÄ±ÄŸÄ± config
        const firebaseConfig = {
            apiKey: "AIzaSyC60idSLdAiqAjPWAOMaM3g8LAKPGEUwH8",
            authDomain: "vr-sinema.firebaseapp.com",
            databaseURL: "https://vr-sinema-default-rtdb.firebaseio.com",
            projectId: "vr-sinema",
            storageBucket: "vr-sinema.firebasestorage.app",
            messagingSenderId: "724648238300",
            appId: "1:724648238300:web:dceba8c536e8a5ffd96819"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // Global DeÄŸiÅŸkenler
        let currentUser = null;
        let roomId = null;
        let isOwner = false;
        let videoEl = document.getElementById('main-video');
        let serverTimeOffset = 0;
        let syncInterval = null;
        let avatarUpdateInterval = null;
        
        // Sync ToleranslarÄ±
        const SYNC_THRESHOLD = 0.5; // 0.5 saniye fark kabul edilebilir
        const HARD_SYNC_THRESHOLD = 3.0; // 3 saniye fark varsa sert atlama yap
        const NETWORK_LATENCY_BUFFER = 0.2; // AÄŸ gecikmesi tahmini

        // ==========================================
        // 1. GÄ°RÄ°Åž & ODA YÃ–NETÄ°MÄ°
        // ==========================================
        async function enterCinema() {
            const username = document.getElementById('username').value.trim() || 'Misafir';
            const roomInput = document.getElementById('room-id').value.trim();
            const urlInput = document.getElementById('video-url').value.trim();

            document.getElementById('loader').style.display = 'block';
            
            try {
                // Anonim GiriÅŸ
                const userCred = await auth.signInAnonymously();
                currentUser = userCred.user;
                
                // Oda ID Belirleme
                roomId = roomInput || Math.random().toString(36).substring(2, 8);
                
                // Oda Var mÄ± KontrolÃ¼
                const roomRef = db.ref(`rooms/${roomId}`);
                const snapshot = await roomRef.once('value');
                
                if (!snapshot.exists()) {
                    // Yeni Oda
                    isOwner = true;
                    await roomRef.set({
                        owner: currentUser.uid,
                        videoUrl: urlInput,
                        created: firebase.database.ServerValue.TIMESTAMP,
                        state: {
                            isPlaying: false,
                            position: 0,
                            timestamp: firebase.database.ServerValue.TIMESTAMP, // Son gÃ¼ncelleme zamanÄ±
                            playbackRate: 1
                        }
                    });
                } else {
                    // Mevcut Oda
                    const data = snapshot.val();
                    // EÄŸer oda sahibi dÃ¼ÅŸmÃ¼ÅŸse ve oda boÅŸsa sahipliÄŸi al (opsiyonel, burada basit tutuyoruz)
                    if (data.videoUrl && !roomInput) { 
                        // Odaya url input ile girmeye Ã§alÄ±ÅŸtÄ± ama oda zaten var, mevcut URL'i kullan
                    }
                    if(data.videoUrl) {
                        videoEl.src = data.videoUrl;
                    }
                }

                // UI TemizliÄŸi
                document.getElementById('lobby-overlay').classList.add('hidden');
                document.getElementById('hud').classList.add('visible');
                
                if (isOwner) {
                    videoEl.src = urlInput;
                    document.getElementById('vr-controls').setAttribute('visible', true);
                    // Video URL'ini db'ye de yaz, garanti olsun
                    roomRef.update({ videoUrl: urlInput });
                }

                // Video YÃ¼kleme
                videoEl.load();

                // Sistemleri BaÅŸlat
                startClockSync();
                setupPresence(username);
                startVideoSyncListeners();
                startAvatarSystem();

                // Ä°lk etkileÅŸim uyarÄ±sÄ±
                setTimeout(() => {
                    document.getElementById('click-to-start').style.display = 'flex';
                }, 1000);

            } catch (error) {
                console.error("GiriÅŸ HatasÄ±:", error);
                alert("BaÄŸlantÄ± hatasÄ±: " + error.message);
                document.getElementById('loader').style.display = 'none';
            }
        }

        function unlockAudio() {
            // AudioContext kilidini aÃ§mak iÃ§in boÅŸ bir play/pause yap
            videoEl.play().then(() => {
                videoEl.pause();
                document.getElementById('click-to-start').style.display = 'none';
                console.log("Audio Unlocked");
            }).catch(e => console.log("Audio unlock failed yet:", e));
        }

        // ==========================================
        // 2. TIME SYNCHRONIZATION (NTP Style)
        // ==========================================
        function startClockSync() {
            const offsetRef = db.ref('.info/serverTimeOffset');
            offsetRef.on('value', (snap) => {
                serverTimeOffset = snap.val();
                console.log('â° Server Time Offset:', serverTimeOffset);
            });
        }

        function getServerTime() {
            return Date.now() + serverTimeOffset;
        }

        // ==========================================
        // 3. VIDEO SYNC ENGINE (Core Logic)
        // ==========================================
        function startVideoSyncListeners() {
            const stateRef = db.ref(`rooms/${roomId}/state`);

            stateRef.on('value', (snapshot) => {
                if (!snapshot.exists()) return;
                
                const serverState = snapshot.val();
                handleRemoteStateChange(serverState);
            });
        }

        function handleRemoteStateChange(state) {
            // EÄŸer ben yÃ¶neticiysem ve son komutu ben verdiysem (loop Ã¶nleme),
            // yine de drift check yapmalÄ±yÄ±m ama agresif olmamalÄ±.
            
            // Hesaplanan ÅŸu anki sunucu zamanÄ±
            const now = getServerTime();
            
            // State'in gÃ¼ncellendiÄŸi zamandan bu yana geÃ§en sÃ¼re (ms)
            const timePassed = now - state.timestamp;
            
            // Videonun ÅŸu an olmasÄ± gereken pozisyonu (saniye cinsinden)
            let targetPosition = state.position;
            
            if (state.isPlaying) {
                targetPosition += (timePassed / 1000);
            }

            // Debug
            const drift = targetPosition - videoEl.currentTime;
            document.getElementById('debug-text').innerText = `Drift: ${drift.toFixed(3)}s`;

            // MantÄ±k
            if (Math.abs(drift) > HARD_SYNC_THRESHOLD) {
                // Ã‡ok geride/ileride kaldÄ±, sert atlama yap
                console.log("âš ï¸ Hard Sync Triggered");
                videoEl.currentTime = targetPosition + NETWORK_LATENCY_BUFFER;
            } else if (Math.abs(drift) > SYNC_THRESHOLD) {
                // Ufak kayma var, hÄ±zÄ± deÄŸiÅŸtirerek yakala (Soft Sync)
                // EÄŸer gerideysem hÄ±zlan, ilerideysem yavaÅŸla
                if (drift > 0) {
                    videoEl.playbackRate = 1.1; // HÄ±zlan
                } else {
                    videoEl.playbackRate = 0.9; // YavaÅŸla
                }
            } else {
                // Senkronuz, hÄ±zÄ± normale Ã§ek
                videoEl.playbackRate = 1.0;
            }

            // Oynatma Durumu KontrolÃ¼
            if (state.isPlaying && videoEl.paused) {
                videoEl.play().catch(e => console.warn("Autoplay engellendi:", e));
            } else if (!state.isPlaying && !videoEl.paused) {
                videoEl.pause();
                // Pause durumunda tam pozisyona sabitle
                videoEl.currentTime = state.position;
            }
        }

        // --- OWNER CONTROLS ---
        
        function updateServerState(isPlaying, position) {
            if (!isOwner) return;

            const payload = {
                isPlaying: isPlaying,
                position: position,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                playbackRate: 1
            };

            db.ref(`rooms/${roomId}/state`).set(payload);
        }

        function togglePlay() {
            if (!isOwner) return;
            const willPlay = videoEl.paused;
            updateServerState(willPlay, videoEl.currentTime);
        }

        function seekRelative(seconds) {
            if (!isOwner) return;
            let newTime = videoEl.currentTime + seconds;
            if (newTime < 0) newTime = 0;
            updateServerState(videoEl.paused ? false : true, newTime);
        }

        function forceSync() {
            if (!isOwner) return;
            updateServerState(false, videoEl.currentTime); // Herkesi durdur ve buraya Ã§ek
            setTimeout(() => {
                updateServerState(true, videoEl.currentTime); // BaÅŸlat
            }, 1000);
        }

        // Owner iÃ§in local event listenerlar (UI dÄ±ÅŸÄ± kontroller iÃ§in)
        // Video elementine doÄŸrudan mÃ¼dahale edilirse (Ã¶rneÄŸin klavye ile), bunu sunucuya bildir.
        // Not: Sonsuz dÃ¶ngÃ¼yÃ¼ engellemek iÃ§in dikkatli olunmalÄ±. 
        // En saÄŸlÄ±klÄ±sÄ± sadece butonlar Ã¼zerinden kontrol saÄŸlamaktÄ±r.
        
        // ==========================================
        // 4. PRESENCE & AVATARS
        // ==========================================
        function setupPresence(username) {
            const userRef = db.ref(`rooms/${roomId}/users/${currentUser.uid}`);
            
            // BaÄŸlantÄ± koparsa sil
            userRef.onDisconnect().remove();

            // Kendini kaydet
            userRef.set({
                name: username,
                color: '#' + Math.floor(Math.random()*16777215).toString(16),
                position: {x:0, y:0, z:0},
                rotation: {x:0, y:0, z:0}
            });

            // BaÅŸkalarÄ±nÄ± dinle
            const usersRef = db.ref(`rooms/${roomId}/users`);
            usersRef.on('value', (snapshot) => {
                const users = snapshot.val() || {};
                updateAvatars(users);
                
                // Ä°zleyici SayÄ±sÄ±
                const count = Object.keys(users).length;
                document.getElementById('viewer-count-display').innerText = count;
            });
        }

        function startAvatarSystem() {
            const cam = document.getElementById('local-camera');
            const rig = document.getElementById('camera-rig');

            // Saniyede 10 kez konum gÃ¶nder (Optimization)
            avatarUpdateInterval = setInterval(() => {
                if(!currentUser) return;
                
                const pos = rig.getAttribute('position');
                const rot = cam.getAttribute('rotation'); // Sadece kafanÄ±n dÃ¶nÃ¼ÅŸÃ¼ Ã¶nemli

                db.ref(`rooms/${roomId}/users/${currentUser.uid}`).update({
                    position: pos,
                    rotation: rot
                });
            }, 100);
        }

        function updateAvatars(usersData) {
            const container = document.getElementById('avatar-container');
            const currentAvatars = Array.from(container.children);
            
            // Aktif kullanÄ±cÄ± ID'leri
            const activeIds = Object.keys(usersData).filter(id => id !== currentUser.uid);

            // 1. OlmayanlarÄ± sil
            currentAvatars.forEach(avatar => {
                if (!activeIds.includes(avatar.id)) {
                    avatar.remove();
                }
            });

            // 2. Yeni ekle veya gÃ¼ncelle
            activeIds.forEach(id => {
                const userData = usersData[id];
                let avatar = document.getElementById(id);

                if (!avatar) {
                    // Avatar OluÅŸtur
                    avatar = document.createElement('a-entity');
                    avatar.id = id;
                    
                    // Kafa
                    const head = document.createElement('a-entity');
                    head.setAttribute('mixin', 'avatar-head');
                    head.setAttribute('material', `color: ${userData.color}`);
                    avatar.appendChild(head);

                    // Ä°sim Etiketi
                    const text = document.createElement('a-text');
                    text.setAttribute('value', userData.name);
                    text.setAttribute('align', 'center');
                    text.setAttribute('position', '0 0.6 0');
                    text.setAttribute('scale', '0.5 0.5 0.5');
                    text.setAttribute('side', 'double');
                    avatar.appendChild(text);

                    container.appendChild(avatar);
                }

                // Pozisyon GÃ¼ncelle (Lerp eklenebilir ama basit tutuyoruz)
                // A-Frame pozisyon objesi {x, y, z} bekler
                if(userData.position) {
                    avatar.setAttribute('position', userData.position);
                }
                if(userData.rotation) {
                    // Sadece kafa dÃ¶nsÃ¼n
                    avatar.children[0].setAttribute('rotation', userData.rotation);
                }
            });
        }

    </script>
</body>
</html>